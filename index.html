<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ¼åŠ¨è¿½è¸ªæ•°æ®æ”¶é›†ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script>
         // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyB6O5l6uZa-6sywCZTGRJx2CKPuq3KeBF0",
            authDomain: "index-9f58d.firebaseapp.com",
            projectId: "index-9f58d",
            storageBucket: "index-9f58d.firebasestorage.app",
            messagingSenderId: "718279245978",
            appId: "1:718279245978:web:93a9a07473ad8d3e6a5f23"
        };
        
        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ç¡®ä¿å˜é‡ä¸ä¸º undefined
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const userId = 'jingtianwei2002';
        console.log('ä¼šè¯ID:', sessionId);
        console.log('ç”¨æˆ·ID:', userId);

        // åŠ¨æ€åŠ è½½WebGazer - ä¼˜åŒ–ç‰ˆæœ¬
        async function loadWebGazerScript() {
            const sources = [
                'https://webgazer.cs.brown.edu/webgazer.js',
                'https://unpkg.com/webgazer@2.0.2/dist/webgazer.js',
                'https://cdn.jsdelivr.net/npm/webgazer@2.0.2/dist/webgazer.min.js'
            ];

            for (const source of sources) {
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = source;
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`æ— æ³•ä» ${source} åŠ è½½WebGazer`));
                        script.timeout = 10000; // 10ç§’è¶…æ—¶
                        document.head.appendChild(script);
                    });
                    console.log(`WebGazerä» ${source} åŠ è½½æˆåŠŸ`);
                    return true;
                } catch (error) {
                    console.error(`åŠ è½½å¤±è´¥: ${error.message}`);
                }
            }
            return false;
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #heatmapContainer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: -1000;
            opacity: 0.7;
            display: none;
        }
        
        #plotting_canvas {
            position: fixed;
            top: 0;
            left: 0;
            cursor: crosshair;
            z-index: 900;
            pointer-events: none;
        }
        
        #content { 
            position: relative; 
            z-index: 1; 
            padding: 50px; 
            max-width: 800px;
            margin: 0 auto;
            background: white;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #statsPanel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 2000;
            width: 280px;
            font-size: 12px;
        }
        
        .stat-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .stat-value {
            font-weight: bold;
            color: #4CAF50;
        }
        
        #debugPanel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            z-index: 2000;
            max-width: 350px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .test-area {
            height: 150px;
            margin: 30px 0;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-area:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .area-blue { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; }
        .area-green { background: linear-gradient(135deg, #00b894, #00a085); color: white; }
        .area-orange { background: linear-gradient(135deg, #fdcb6e, #e17055); color: white; }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover { background: #45a049; }
        .btn.danger { background: #f44336; }
        .btn.danger:hover { background: #da190b; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn.test { background: #2196F3; }
        .btn.test:hover { background: #1976D2; }
        .btn.toggle { background: #FF9800; }
        .btn.toggle:hover { background: #F57C00; }
        
        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 2000;
        }
        
        .status.ready { background: #4CAF50; color: white; }
        .status.calibrating { background: #ff9800; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.initializing { background: #2196F3; color: white; }
        .status.loading { background: #9C27B0; color: white; }
        
        .loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            z-index: 3000;
            transition: width 0.3s ease;
        }
        
        #webgazerVideoContainer {
            position: fixed !important;
            top: 10px !important;
            right: 320px !important;
            z-index: 1999 !important;
            width: 240px !important;
            height: 180px !important;
        }
        
        #webgazerVideoFeed {
            width: 100% !important;
            height: 100% !important;
            border-radius: 8px !important;
            border: 2px solid #4CAF50 !important;
        }
        
        .Calibration {
            width: 20px !important;
            height: 20px !important;
            border-radius: 50% !important;
            background-color: red !important;
            border: solid white 3px !important;
            position: fixed !important;
            z-index: 100000 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            opacity: 0.9 !important;
        }
        
        .Calibration:hover {
            transform: scale(1.5) !important;
            background-color: yellow !important;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.8) !important;
        }
        
        .Calibration.clicked {
            background-color: yellow !important;
            border-color: orange !important;
            transform: scale(0.8) !important;
        }
        
        #Pt1 { top: 10% !important; left: 10% !important; }
        #Pt2 { top: 10% !important; left: 50% !important; margin-left: -10px !important; }
        #Pt3 { top: 10% !important; right: 10% !important; }
        #Pt4 { top: 50% !important; margin-top: -10px !important; left: 10% !important; }
        #Pt5 { top: 50% !important; margin-top: -10px !important; left: 50% !important; margin-left: -10px !important; }
        #Pt6 { top: 50% !important; margin-top: -10px !important; right: 10% !important; }
        #Pt7 { bottom: 10% !important; left: 10% !important; }
        #Pt8 { bottom: 10% !important; left: 50% !important; margin-left: -10px !important; }
        #Pt9 { bottom: 10% !important; right: 10% !important; }
        
        #Accuracy {
            background-color: #222;
            color: white;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        .collection-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }
        .collection-status.connected { background: #4CAF50; color: white; }
        .collection-status.disconnected { background: #f44336; color: white; }
        .collection-status.uploading { background: #ff9800; color: white; }

        .firebase-status {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }

        .heatmap-visible {
            opacity: 0.7 !important;
            display: block !important;
        }
    </style>
</head>
<body>
    <div id="loadingBar" class="loading-bar"></div>
    <div id="status" class="status loading">æ­£åœ¨åŠ è½½åº“æ–‡ä»¶...</div>
    <canvas id="plotting_canvas" width="500" height="500"></canvas>

    <div id="statsPanel">
        <h4 style="margin: 0 0 10px 0; text-align: center; color: #4CAF50;">ğŸ“Š çœ¼åŠ¨æ•°æ®ç»Ÿè®¡</h4>
        <div class="stat-item">
            <span>ä¼šè¯ID:</span>
            <span id="sessionIdDisplay" class="stat-value" style="font-size: 10px; word-break: break-all;"></span>
        </div>
        <div class="stat-item">
            <span>æ³¨è§†ç‚¹æ€»æ•°:</span>
            <span id="totalGazes" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>çœ¼è·³æ¬¡æ•°:</span>
            <span id="saccadeCount" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>æ³¨è§†æ¬¡æ•°:</span>
            <span id="fixationCount" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>å¹³å‡æ³¨è§†æ—¶é—´:</span>
            <span id="avgFixationTime" class="stat-value">0ms</span>
        </div>
        <div class="stat-item">
            <span>çƒ­åŠ›å›¾å¿«ç…§:</span>
            <span id="heatmapSnapshots" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>æ•°æ®å¿«ç…§æ•°:</span>
            <span id="snapshotCount" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>è¿è¡Œæ—¶é—´:</span>
            <span id="runningTime" class="stat-value">0s</span>
        </div>
        <div id="Accuracy">ç­‰å¾…æ ¡å‡†...</div>
        <div class="stat-item">
            <span>ç³»ç»ŸçŠ¶æ€:</span>
            <span id="systemStatus" class="stat-value">åŠ è½½ä¸­</span>
        </div>
        <div class="collection-status disconnected" id="collectionStatus">
            ğŸ“ˆ æ•°æ®æ”¶é›†: æœªå¼€å§‹
        </div>
        <div class="firebase-status disconnected" id="firebaseStatus">
            ğŸ”¥ Firebase: æœªè¿æ¥
        </div>
        
        <button class="btn test" onclick="testFirebaseConnection()" style="width: 100%; margin: 8px 0 0 0; padding: 6px; font-size: 12px;">
            ğŸ§ª æµ‹è¯•è¿æ¥
        </button>
        <button class="btn test" onclick="forceSaveData()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">
            ğŸ’¾ å¼ºåˆ¶ä¿å­˜
        </button>
        <button class="btn toggle" onclick="toggleHeatmap()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">
            ğŸ”¥ æ˜¾ç¤ºçƒ­åŠ›å›¾
        </button>
        <button class="btn test" onclick="toggleDebug()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">
            ğŸ› æ˜¾ç¤ºè°ƒè¯•
        </button>
    </div>

    <div id="debugPanel">
        <div id="debugInfo">è°ƒè¯•ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
    </div>

    <div id="heatmapContainer"></div>

    <div class="calibrationDiv">
        <div class="Calibration" id="Pt1" style="display: none;"></div>
        <div class="Calibration" id="Pt2" style="display: none;"></div>
        <div class="Calibration" id="Pt3" style="display: none;"></div>
        <div class="Calibration" id="Pt4" style="display: none;"></div>
        <div class="Calibration" id="Pt5" style="display: none;"></div>
        <div class="Calibration" id="Pt6" style="display: none;"></div>
        <div class="Calibration" id="Pt7" style="display: none;"></div>
        <div class="Calibration" id="Pt8" style="display: none;"></div>
        <div class="Calibration" id="Pt9" style="display: none;"></div>
    </div>

    <div id="content">
        <h1 style="text-align: center; color: #333;">ğŸ‘ï¸ çœ¼åŠ¨è¿½è¸ªæ•°æ®æ”¶é›†ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</h1>
        
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startEyeTracking()" disabled>ğŸš€ å¯åŠ¨çœ¼åŠ¨è¿½è¸ª</button>
            <button class="btn" id="calibrateBtn" onclick="PopUpInstruction()" disabled>ğŸ¯ å¼€å§‹æ ¡å‡†</button>
            <button class="btn" onclick="Restart()">ğŸ”„ é‡æ–°æ ¡å‡†</button>
            <button class="btn" onclick="exportData()">ğŸ“Š å¯¼å‡ºæ•°æ®</button>
            <button class="btn danger" onclick="stopTracking()">â¹ï¸ åœæ­¢è¿½è¸ª</button>
        </div>
        
        <p style="text-align: center; font-size: 18px; color: #666; margin: 30px 0;">
            ğŸ‘€ è¯·è‡ªç„¶åœ°æµè§ˆä¸‹é¢çš„å†…å®¹ï¼Œç³»ç»Ÿä¼šå®Œæ•´æ”¶é›†æ‚¨çš„çœ¼åŠ¨æ•°æ®
        </p>
        
        <div class="test-area area-blue" onclick="debug('ç‚¹å‡»äº†è“è‰²åŒºåŸŸ')">
            <h2>ğŸŒŠ åŒºåŸŸ A - æµ·æ´‹è“</h2>
            <p>è¿™æ˜¯ç¬¬ä¸€ä¸ªæµ‹è¯•åŒºåŸŸã€‚è¯·å°è¯•æ³¨è§†è¿™é‡Œå‡ ç§’é’Ÿï¼Œç³»ç»Ÿä¼šè®°å½•æ‚¨çš„æ³¨è§†ç‚¹åæ ‡ã€æ³¨è§†æ—¶é—´å’Œçœ¼åŠ¨æ¨¡å¼ã€‚</p>
        </div>
        
        <div class="test-area area-green" onclick="debug('ç‚¹å‡»äº†ç»¿è‰²åŒºåŸŸ')">
            <h2>ğŸŒ¿ åŒºåŸŸ B - æ£®æ—ç»¿</h2>
            <p>è¿™æ˜¯ç¬¬äºŒä¸ªæµ‹è¯•åŒºåŸŸã€‚åœ¨ä¸åŒåŒºåŸŸä¹‹é—´ç§»åŠ¨è§†çº¿ä¼šäº§ç”Ÿçœ¼è·³æ•°æ®ï¼ŒåŒ…æ‹¬ç§»åŠ¨è·ç¦»å’Œé€Ÿåº¦ã€‚</p>
        </div>
        
        <div class="test-area area-orange" onclick="debug('ç‚¹å‡»äº†æ©™è‰²åŒºåŸŸ')">
            <h2>ğŸ”¥ åŒºåŸŸ C - å¤•é˜³æ©™</h2>
            <p>è¿™æ˜¯ç¬¬ä¸‰ä¸ªæµ‹è¯•åŒºåŸŸã€‚é•¿æ—¶é—´æ³¨è§†ä¼šç”Ÿæˆæ³¨è§†æ•°æ®ï¼ŒåŒ…æ‹¬æ³¨è§†ä½ç½®å’ŒæŒç»­æ—¶é—´ã€‚ç³»ç»Ÿæ¯ç§’ä¼šç”Ÿæˆä¸€å¼ çƒ­åŠ›å›¾å¿«ç…§ä¿å­˜åˆ°äº‘ç«¯ã€‚</p>
        </div>
        
        <div style="text-align: center; margin: 40px 0; padding: 20px; background: #e8f5e8; border-radius: 8px;">
            <h4 style="color: #2e7d32; margin-bottom: 15px;">ğŸ“‹ å®Œæ•´åŠŸèƒ½è¯´æ˜</h4>
            <p style="margin: 8px 0; color: #555;">âœ… æ³¨è§†ç‚¹è¿½è¸ª - å®æ—¶è®°å½•çœ¼çƒæ³¨è§†ä½ç½®</p>
            <p style="margin: 8px 0; color: #555;">âœ… çœ¼è·³æ£€æµ‹ - è‡ªåŠ¨è¯†åˆ«çœ¼çƒå¿«é€Ÿç§»åŠ¨</p>
            <p style="margin: 8px 0; color: #555;">âœ… æ³¨è§†æ—¶é—´ç»Ÿè®¡ - è®¡ç®—æ³¨è§†æŒç»­æ—¶é—´å’Œæ¬¡æ•°</p>
            <p style="margin: 8px 0; color: #555;">âœ… çƒ­åŠ›å›¾ç”Ÿæˆ - æ¯ç§’è‡ªåŠ¨ç”Ÿæˆçƒ­åŠ›å›¾å¿«ç…§</p>
            <p style="margin: 8px 0; color: #555;">âœ… äº‘ç«¯å­˜å‚¨ - æ‰€æœ‰æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°Firebase</p>
            <p style="margin: 8px 0; color: #555;">âœ… 9ç‚¹æ ¡å‡† - ä½¿ç”¨æ ‡å‡†WebGazeræ ¡å‡†æµç¨‹</p>
        </div>
    </div>

    <script>
        // ===========================================
        // å…¨å±€å˜é‡å®šä¹‰
        // ===========================================
        let heatmapInstance = null;
        let gazeCount = 0;
        let snapshotCount = 0;
        let heatmapSnapshotCount = 0;
        let saccadeCount = 0;
        let fixationCount = 0;
        let totalFixationTime = 0;
        let startTime = Date.now();
        let isTracking = false;
        let webgazerReady = false;
        let debugMode = false;
        let heatmapVisible = false;
        let librariesLoaded = false;
        let firebaseConnected = false;
        
        var PointCalibrate = 0;
        var CalibrationPoints = {};
        
        // çœ¼åŠ¨æ•°æ®ç»“æ„
        let eyeTrackingData = {
            gazePoints: [],
            saccades: [],
            fixations: [],
            heatmapSnapshots: [],
            calibrationData: {
                points: [],
                accuracy: null,
                timestamp: null
            }
        };

        // ç”¨äºçœ¼è·³å’Œæ³¨è§†æ£€æµ‹çš„å˜é‡
        let lastGazePoint = null;
        let currentFixation = null;
        const fixationThreshold = 50; // åƒç´ é˜ˆå€¼
        const fixationTimeThreshold = 100; // æ¯«ç§’é˜ˆå€¼

        let autoSaveInterval = null;
        let heatmapSnapshotInterval = null;
        let statsUpdateInterval = null;

        document.getElementById('sessionIdDisplay').textContent = sessionId;

        // ===========================================
        // æ ¸å¿ƒå‡½æ•°
        // ===========================================
        function debug(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[DEBUG ${timestamp}] ${message}`);
            
            if (debugMode && document.getElementById('debugInfo')) {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML = `[${timestamp}] ${message}<br>` + debugDiv.innerHTML;
                const lines = debugDiv.innerHTML.split('<br>');
                if (lines.length > 30) {
                    debugDiv.innerHTML = lines.slice(0, 30).join('<br>');
                }
            }
        }

        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
            }
            document.getElementById('systemStatus').textContent = message;
            debug(`çŠ¶æ€æ›´æ–°: ${message}`);
        }

        function updateFirebaseStatus(message, status) {
            const statusElement = document.getElementById('firebaseStatus');
            if (statusElement) {
                statusElement.textContent = `ğŸ”¥ Firebase: ${message}`;
                statusElement.className = `firebase-status ${status}`;
            }
        }

        function updateCollectionStatus(message, status) {
            const statusElement = document.getElementById('collectionStatus');
            if (statusElement) {
                statusElement.textContent = `ğŸ“ˆ æ•°æ®æ”¶é›†: ${message}`;
                statusElement.className = `collection-status ${status}`;
            }
        }

        // ===========================================
        // Firebase å‡½æ•°
        // ===========================================
        async function testFirebaseConnection() {
            debug('å¼€å§‹æµ‹è¯•Firebaseè¿æ¥...');
            updateFirebaseStatus('æµ‹è¯•ä¸­...', 'uploading');
            try {
                await db.collection("connection_test").add({
                    sessionId: sessionId,
                    userId: userId,
                    timestamp: new Date().toISOString(),
                    testType: 'connection_test',
                    systemInfo: { userAgent: navigator.userAgent }
                });
                debug('Firebaseè¿æ¥æµ‹è¯•æˆåŠŸï¼');
                updateFirebaseStatus('è¿æ¥æ­£å¸¸', 'connected');
                firebaseConnected = true;
                swal('æˆåŠŸ', 'Firebaseè¿æ¥æµ‹è¯•æˆåŠŸï¼æ•°æ®æ”¶é›†å·²å°±ç»ªã€‚', 'success');
                return true;
            } catch (error) {
                console.error("Firebase Connection Test Failed: ", error);
                debug(`Firebaseè¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateFirebaseStatus('è¿æ¥å¤±è´¥', 'disconnected');
                firebaseConnected = false;
                swal('å¤±è´¥', `Firebaseè¿æ¥æµ‹è¯•å¤±è´¥ï¼è¯·æ£€æŸ¥æ‚¨çš„Firebaseé…ç½®å’Œç½‘ç»œè¿æ¥ã€‚\n\n${error.message}`, 'error');
                return false;
            }
        }

        async function forceSaveData() {
            if (!isTracking) {
                swal('æç¤º', 'è¯·å…ˆå¯åŠ¨çœ¼åŠ¨è¿½è¸ªå†ä¿å­˜æ•°æ®ã€‚', 'info');
                return;
            }
            await saveEyeTrackingData(true);
        }
        
        // ===========================================
        // çœ¼åŠ¨æ•°æ®å¤„ç†
        // ===========================================
        function gazeDataCallback(data, elapsedTime) {
            if (!isTracking || data == null || typeof data.x !== 'number' || typeof data.y !== 'number' || isNaN(data.x) || isNaN(data.y) || data.x < 0 || data.y < 0) {
                return;
            }
            
            const timestamp = new Date().toISOString();
            let gazePoint = {
                x: Math.floor(data.x),
                y: Math.floor(data.y),
                timestamp: timestamp,
                elapsedTime: elapsedTime || Date.now() - startTime,
                sessionId: sessionId,
                userId: userId
            };

            processSaccadeAndFixation(gazePoint);

            eyeTrackingData.gazePoints.push(gazePoint);
            
            if (heatmapInstance) {
                heatmapInstance.addData({ x: gazePoint.x, y: gazePoint.y, value: 5 });
            }
            
            gazeCount++;
            
            if (gazeCount % 100 === 0) {
                updateStatsDisplay();
            }
        }

        function processSaccadeAndFixation(gazePoint) {
            if (!lastGazePoint) {
                lastGazePoint = gazePoint;
                currentFixation = {
                    startPoint: {...gazePoint},
                    startTime: gazePoint.timestamp,
                    pointCount: 1,
                    sessionId: sessionId,
                    userId: userId
                };
                return;
            }

            const distance = Math.sqrt(Math.pow(gazePoint.x - lastGazePoint.x, 2) + Math.pow(gazePoint.y - lastGazePoint.y, 2));

            if (distance > fixationThreshold) {
                if (currentFixation && currentFixation.pointCount > 1) {
                    const fixationDuration = new Date(gazePoint.timestamp).getTime() - new Date(currentFixation.startTime).getTime();
                    if (fixationDuration > fixationTimeThreshold) {
                        currentFixation.endTime = lastGazePoint.timestamp;
                        currentFixation.duration = fixationDuration;
                        currentFixation.endPoint = {...lastGazePoint};
                        currentFixation.centerPoint = {
                            x: Math.round((currentFixation.startPoint.x + currentFixation.endPoint.x) / 2),
                            y: Math.round((currentFixation.startPoint.y + currentFixation.endPoint.y) / 2)
                        };
                        
                        eyeTrackingData.fixations.push({...currentFixation});
                        fixationCount++;
                        totalFixationTime += fixationDuration;
                    }
                }

                const saccadeDuration = new Date(gazePoint.timestamp).getTime() - new Date(lastGazePoint.timestamp).getTime();
                eyeTrackingData.saccades.push({
                    startPoint: {...lastGazePoint},
                    endPoint: {...gazePoint},
                    distance: Math.round(distance),
                    startTime: lastGazePoint.timestamp,
                    endTime: gazePoint.timestamp,
                    duration: saccadeDuration,
                    velocity: saccadeDuration > 0 ? Math.round(distance / saccadeDuration * 1000) : 0,
                    sessionId: sessionId,
                    userId: userId
                });
                saccadeCount++;

                currentFixation = {
                    startPoint: {...gazePoint},
                    startTime: gazePoint.timestamp,
                    pointCount: 1,
                    sessionId: sessionId,
                    userId: userId
                };
            } else {
                if (currentFixation) {
                    currentFixation.pointCount++;
                }
            }
            lastGazePoint = gazePoint;
        }

        function updateStatsDisplay() {
            document.getElementById('totalGazes').textContent = gazeCount;
            document.getElementById('saccadeCount').textContent = saccadeCount;
            document.getElementById('fixationCount').textContent = fixationCount;
            document.getElementById('heatmapSnapshots').textContent = heatmapSnapshotCount;
            document.getElementById('snapshotCount').textContent = snapshotCount;
            const avgTime = fixationCount > 0 ? Math.round(totalFixationTime / fixationCount) : 0;
            document.getElementById('avgFixationTime').textContent = avgTime + 'ms';
        }
        
        // ===========================================
        // çƒ­åŠ›å›¾å¿«ç…§åŠŸèƒ½
        // ===========================================
        function startHeatmapSnapshots() {
            if (heatmapSnapshotInterval) clearInterval(heatmapSnapshotInterval);
            heatmapSnapshotInterval = setInterval(() => {
                if (heatmapInstance && isTracking && gazeCount > 0) {
                    captureHeatmapSnapshot();
                }
            }, 1000); // æ¯ç§’ä¸€å¼ å¿«ç…§
            debug('çƒ­åŠ›å›¾å¿«ç…§åŠŸèƒ½å·²å¯åŠ¨ (æ¯ç§’è‡ªåŠ¨ä¿å­˜)');
        }

        function stopHeatmapSnapshots() {
            if (heatmapSnapshotInterval) clearInterval(heatmapSnapshotInterval);
            heatmapSnapshotInterval = null;
            debug('çƒ­åŠ›å›¾å¿«ç…§åŠŸèƒ½å·²åœæ­¢');
        }

        function captureHeatmapSnapshot() {
            try {
                const canvas = document.getElementById('heatmapContainer').querySelector('canvas');
                if (canvas && heatmapInstance) {
                    heatmapInstance.repaint();
                    setTimeout(() => {
                        try {
                            const dataURL = canvas.toDataURL('image/png', 0.8);
                            eyeTrackingData.heatmapSnapshots.push({
                                timestamp: new Date().toISOString(),
                                imageData: dataURL,
                                snapshotIndex: heatmapSnapshotCount + 1,
                                sessionId: sessionId,
                                userId: userId,
                                metadata: {
                                    viewport: { width: window.innerWidth, height: window.innerHeight },
                                    scroll: { x: window.scrollX, y: window.scrollY }
                                }
                            });
                            heatmapSnapshotCount++;
                            debug(`çƒ­åŠ›å›¾å¿«ç…§ #${heatmapSnapshotCount} å·²ä¿å­˜`);
                            updateStatsDisplay();
                        } catch (e) {
                            debug(`çƒ­åŠ›å›¾å¿«ç…§ toDataURL å¤±è´¥: ${e.message}`);
                        }
                    }, 150);
                }
            } catch (error) {
                debug(`çƒ­åŠ›å›¾å¿«ç…§æ•è·å¤±è´¥: ${error.message}`);
            }
        }
        
        // ===========================================
        // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
        // ===========================================
        function startAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            autoSaveInterval = setInterval(() => saveEyeTrackingData(false), 10000); // 10ç§’ä¿å­˜ä¸€æ¬¡
            updateCollectionStatus('è¿›è¡Œä¸­ (è‡ªåŠ¨ä¿å­˜)', 'connected');
            debug('è‡ªåŠ¨ä¿å­˜å·²å¯åŠ¨ (æ¯10ç§’ä¿å­˜ä¸€æ¬¡)');
        }

        function stopAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            autoSaveInterval = null;
            updateCollectionStatus('å·²åœæ­¢', 'disconnected');
            debug('è‡ªåŠ¨ä¿å­˜å·²åœæ­¢');
        }

        async function saveEyeTrackingData(isManual = false) {
            if (!firebaseConnected) {
                if(isManual) swal('é”™è¯¯', 'Firebaseæœªè¿æ¥ï¼Œæ— æ³•ä¿å­˜æ•°æ®ã€‚è¯·å…ˆæµ‹è¯•è¿æ¥ã€‚', 'error');
                return;
            }
            
            const totalDataPoints = eyeTrackingData.gazePoints.length + eyeTrackingData.saccades.length + eyeTrackingData.fixations.length + eyeTrackingData.heatmapSnapshots.length;
            if (totalDataPoints === 0) {
                debug('æ²¡æœ‰æ–°æ•°æ®éœ€è¦ä¿å­˜');
                if(isManual) swal('æç¤º', 'æ²¡æœ‰æ–°çš„çœ¼åŠ¨æ•°æ®å¯ä¾›ä¿å­˜ã€‚', 'info');
                return;
            }

            const dataToSave = JSON.parse(JSON.stringify(eyeTrackingData));

            const payload = {
                sessionId, userId,
                timestamp: new Date().toISOString(),
                dataType: isManual ? 'manual_save' : 'auto_save',
                version: '2.0_complete',
                statistics: {
                    totalGazePoints: dataToSave.gazePoints.length,
                    totalSaccades: dataToSave.saccades.length,
                    totalFixations: dataToSave.fixations.length,
                    totalHeatmapSnapshots: dataToSave.heatmapSnapshots.length,
                },
                systemInfo: {
                    userAgent: navigator.userAgent,
                    screen: { width: screen.width, height: screen.height },
                    viewport: { width: window.innerWidth, height: window.innerHeight }
                },
                gazeData: dataToSave.gazePoints,
                saccadeData: dataToSave.saccades,
                fixationData: dataToSave.fixations,
                heatmapData: dataToSave.heatmapSnapshots,
                calibrationInfo: dataToSave.calibrationData
            };
            
            // åœ¨ä¿å­˜å‰ï¼Œå…ˆæ¸…ç©ºæœ¬åœ°æ•°æ®ï¼Œé˜²æ­¢é‡å¤ä¸Šä¼ 
            eyeTrackingData.gazePoints = [];
            eyeTrackingData.saccades = [];
            eyeTrackingData.fixations = [];
            eyeTrackingData.heatmapSnapshots = [];

            updateCollectionStatus('ä¿å­˜ä¸­...', 'uploading');
            try {
                const docRef = await db.collection("eye_tracking_comprehensive_v2").add(payload);
                snapshotCount++;
                updateCollectionStatus('è¿›è¡Œä¸­ (è‡ªåŠ¨ä¿å­˜)', 'connected');
                debug(`æ•°æ®å¿«ç…§ #${snapshotCount} ä¿å­˜æˆåŠŸ (ID: ${docRef.id})`);
                if(isManual) {
                    swal('æˆåŠŸ', `æ•°æ®å·²ä¿å­˜åˆ°Firebaseï¼`, 'success');
                }
            } catch (error) {
                console.error("Firebase Save Failed: ", error);
                debug(`æ•°æ®ä¿å­˜å¤±è´¥: ${error.message}`);
                updateCollectionStatus('ä¿å­˜å¤±è´¥', 'disconnected');
                if(isManual) swal('å¤±è´¥', `æ•°æ®ä¿å­˜å¤±è´¥ï¼\n\n${error.message}`, 'error');
                
                // ã€é‡è¦ã€‘å¦‚æœä¸Šä¼ å¤±è´¥ï¼Œå°†æ•°æ®æ¢å¤åˆ°ä¸»æ•°ç»„ä¸­ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
                debug('æ­£åœ¨æ¢å¤æœªæˆåŠŸä¿å­˜çš„æ•°æ®...');
                eyeTrackingData.gazePoints = dataToSave.gazePoints.concat(eyeTrackingData.gazePoints);
                eyeTrackingData.saccades = dataToSave.saccades.concat(eyeTrackingData.saccades);
                eyeTrackingData.fixations = dataToSave.fixations.concat(eyeTrackingData.fixations);
                eyeTrackingData.heatmapSnapshots = dataToSave.heatmapSnapshots.concat(eyeTrackingData.heatmapSnapshots);
            }
        }

        // ===========================================
        // æ ¡å‡†åŠŸèƒ½
        // ===========================================
        function PopUpInstruction() {
            swal({
                title: "æ ¡å‡†è¯´æ˜",
                text: "è¯·ç‚¹å‡»å±å¹•ä¸Šå‡ºç°çš„9ä¸ªçº¢è‰²åœ†ç‚¹è¿›è¡Œæ ¡å‡†ã€‚æ¯ä¸ªç‚¹éœ€è¦å‡†ç¡®ç‚¹å‡»5æ¬¡ã€‚æ ¡å‡†è¿‡ç¨‹ä¸­è¯·ä¿æŒå¤´éƒ¨ç¨³å®šã€‚",
                buttons: { cancel: "å–æ¶ˆ", confirm: "å¼€å§‹æ ¡å‡†" }
            }).then((willCalibrate) => {
                if (willCalibrate) startCalibration();
            });
        }

        function startCalibration() {
            document.getElementById('Accuracy').innerHTML = "æ ¡å‡†ä¸­...";
            updateStatus('æ ¡å‡†è¿›è¡Œä¸­', 'calibrating');
            CalibrationPoints = {};
            PointCalibrate = 0;
            showCalibrationPoint(1);
            debug('å¼€å§‹9ç‚¹æ ¡å‡†æµç¨‹');
        }

        function showCalibrationPoint(num) {
            const point = document.getElementById("Pt" + num);
            if (point) {
                point.style.display = 'block';
                point.onclick = () => calPointClick(point);
            }
        }
        
        function calPointClick(node) {
            var id = node.id;
            if (!CalibrationPoints[id]) CalibrationPoints[id] = 0;
            CalibrationPoints[id]++;
            
            node.classList.add('clicked');
            setTimeout(() => node.classList.remove('clicked'), 200);
            
            if (CalibrationPoints[id] == 5) {
                node.style.opacity = 0.2;
                node.style.backgroundColor = 'yellow';
                node.onclick = null;
                PointCalibrate++;
                if (PointCalibrate < 9) {
                    showCalibrationPoint(PointCalibrate + 1);
                } else {
                    hideAllCalibrationPoints();
                    calculateCalibrationAccuracy();
                }
            } else {
                node.style.opacity = CalibrationPoints[id] * 0.2 + 0.1;
            }
        }

        function hideAllCalibrationPoints() {
            for (let i = 1; i <= 9; i++) {
                const point = document.getElementById("Pt" + i);
                if (point) point.style.display = 'none';
            }
        }

        function calculateCalibrationAccuracy() {
            if (!webgazer.isReady()) {
                 setTimeout(calculateCalibrationAccuracy, 200);
                 return;
            }
            webgazer.getRegression().getAccuracy(function(accuracy) {
                var accuracyStr = accuracy.toFixed(0);
                document.getElementById('Accuracy').innerHTML = "æ ¡å‡†ç²¾åº¦: " + accuracyStr + "px";
                eyeTrackingData.calibrationData = {
                    points: CalibrationPoints,
                    accuracy: accuracyStr,
                    timestamp: new Date().toISOString(),
                    sessionId: sessionId, userId: userId
                };
                updateStatus('æ ¡å‡†å®Œæˆ - ç²¾åº¦: ' + accuracyStr + 'px', 'ready');
                debug(`æ ¡å‡†å®Œæˆï¼Œç²¾åº¦: ${accuracyStr}px`);
                swal('æ ¡å‡†å®Œæˆ', `æ ¡å‡†ç²¾åº¦: ${accuracyStr}px`, 'success');
            });
        }

        function Restart() {
            document.getElementById('Accuracy').innerHTML = "ç­‰å¾…æ ¡å‡†...";
            webgazer.clearData();
            ClearCalibration();
            debug('æ ¡å‡†æ•°æ®å·²æ¸…é™¤ï¼Œå¯é‡æ–°å¼€å§‹æ ¡å‡†');
            updateStatus('å‡†å¤‡é‡æ–°æ ¡å‡†', 'ready');
        }

        function ClearCalibration() {
            hideAllCalibrationPoints();
            CalibrationPoints = {};
            PointCalibrate = 0;
            for (let i = 1; i <= 9; i++) {
                const point = document.getElementById("Pt" + i);
                if (point) {
                    point.style.opacity = '0.9';
                    point.style.backgroundColor = 'red';
                    point.onclick = null;
                }
            }
        }

        // ===========================================
        // å·¥å…·å‡½æ•°
        // ===========================================
        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debugPanel').style.display = debugMode ? 'block' : 'none';
            event.target.textContent = debugMode ? 'ğŸ› éšè—è°ƒè¯•' : 'ğŸ› æ˜¾ç¤ºè°ƒè¯•';
        }

        function toggleHeatmap() {
            heatmapVisible = !heatmapVisible;
            document.getElementById('heatmapContainer').classList.toggle('heatmap-visible');
            event.target.textContent = heatmapVisible ? 'ğŸ”¥ éšè—çƒ­åŠ›å›¾' : 'ğŸ”¥ æ˜¾ç¤ºçƒ­åŠ›å›¾';
        }

        function startStatsUpdate() {
            if (statsUpdateInterval) clearInterval(statsUpdateInterval);
            statsUpdateInterval = setInterval(() => {
                if (isTracking) {
                    document.getElementById('runningTime').textContent = Math.round((Date.now() - startTime) / 1000) + 's';
                    updateStatsDisplay();
                }
            }, 1000);
        }

        function stopStatsUpdate() {
            if (statsUpdateInterval) clearInterval(statsUpdateInterval);
            statsUpdateInterval = null;
        }

        function exportData() {
            if (gazeCount === 0) {
                swal('æ— æ•°æ®', 'æ²¡æœ‰æ”¶é›†åˆ°ä»»ä½•çœ¼åŠ¨æ•°æ®å¯ä¾›å¯¼å‡ºã€‚', 'warning');
                return;
            }
            const dataStr = JSON.stringify({ sessionInfo: { sessionId, userId }, collectedData: eyeTrackingData }, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `eye-tracking-data-${sessionId}.json`;
            link.click();
            URL.revokeObjectURL(url);
            debug(`æ•°æ®å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶`);
            swal('å¯¼å‡ºæˆåŠŸ', 'çœ¼åŠ¨æ•°æ®å·²å¯¼å‡ºåˆ°æœ¬åœ°æ–‡ä»¶ã€‚', 'success');
        }

        // ===========================================
        // ç³»ç»Ÿåˆå§‹åŒ–å’Œæ§åˆ¶
        // ===========================================
        async function initializeSystem() {
            debug('ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹...');
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined') throw new Error('Heatmap.jsæˆ–SweetAlertåº“åŠ è½½å¤±è´¥');
                const webgazerLoaded = await loadWebGazerScript();
                if (!webgazerLoaded || typeof webgazer === 'undefined') throw new Error('WebGazeråº“åŠ è½½å¤±è´¥');
                debug('æ‰€æœ‰å¿…éœ€åº“æ–‡ä»¶åŠ è½½æˆåŠŸ');

                heatmapInstance = h337.create({
                    container: document.getElementById('heatmapContainer'),
                    radius: 25, maxOpacity: 0.6, minOpacity: 0.1, blur: 0.8
                });
                debug('çƒ­åŠ›å›¾å®ä¾‹åˆå§‹åŒ–å®Œæˆ');
                
                await testFirebaseConnection();

                updateStatus('ç³»ç»Ÿå°±ç»ª - ç‚¹å‡»å¯åŠ¨', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;
                debug('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ", error);
                updateStatus('åˆå§‹åŒ–å¤±è´¥', 'error');
                swal('ä¸¥é‡é”™è¯¯', `ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:\n\n${error.message}\n\nè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚`, 'error');
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            const calibrateBtn = document.getElementById('calibrateBtn');
            startBtn.disabled = true;
            updateStatus('åˆå§‹åŒ–WebGazer...', 'initializing');

            try {
                await webgazer.setRegression('ridge').setTracker('clmtrackr').setGazeListener(gazeDataCallback).begin();
                webgazer.showVideoPreview(true).showPredictionPoints(true).applyKalmanFilter(true);
                
                isTracking = true;
                startTime = Date.now();
                webgazerReady = true;
                
                if (firebaseConnected) startAutoSave();
                else updateCollectionStatus('æœ¬åœ°æ”¶é›†ä¸­', 'uploading');
                
                startHeatmapSnapshots();
                startStatsUpdate();
                
                updateStatus('çœ¼åŠ¨è¿½è¸ªè¿è¡Œä¸­', 'ready');
                calibrateBtn.disabled = false;
                startBtn.textContent = 'âœ… è¿è¡Œä¸­';
                swal('å¯åŠ¨æˆåŠŸ', 'çœ¼åŠ¨è¿½è¸ªç³»ç»Ÿå·²å¯åŠ¨ï¼\nå»ºè®®è¿›è¡Œ9ç‚¹æ ¡å‡†ä»¥æé«˜ç²¾åº¦ã€‚', 'success');
            } catch (error) {
                console.error("å¯åŠ¨å¤±è´¥: ", error);
                updateStatus('å¯åŠ¨å¤±è´¥', 'error');
                startBtn.disabled = false;
                isTracking = false;
                swal('å¯åŠ¨å¤±è´¥', `æ— æ³•å¯åŠ¨çœ¼åŠ¨è¿½è¸ªç³»ç»Ÿã€‚\nè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™ç­‰è®¾ç½®ã€‚\n\né”™è¯¯è¯¦æƒ…: ${error.message}`, 'error');
            }
        }

        function stopTracking() {
            if (!isTracking) return;
            swal({
                title: "ç¡®è®¤åœæ­¢", text: "åœæ­¢è¿½è¸ªå°†ä¿å­˜å½“å‰æ‰€æœ‰æ•°æ®ã€‚ç¡®å®šå—ï¼Ÿ",
                icon: "warning", buttons: true, dangerMode: true,
            }).then((willStop) => {
                if (willStop) performStop();
            });
        }

        async function performStop() {
            debug('æ­£åœ¨åœæ­¢çœ¼åŠ¨è¿½è¸ªç³»ç»Ÿ...');
            if (firebaseConnected) await saveEyeTrackingData(true);

            isTracking = false;
            webgazerReady = false;
            stopAutoSave();
            stopHeatmapSnapshots();
            stopStatsUpdate();
            
            if (typeof webgazer !== 'undefined' && webgazer.isReady()) {
                webgazer.end();
            }
            
            ClearCalibration();
            updateStatus('å·²åœæ­¢', 'error');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'ğŸš€ å¯åŠ¨çœ¼åŠ¨è¿½è¸ª';
            document.getElementById('calibrateBtn').disabled = true;
            document.getElementById('Accuracy').innerHTML = "ç­‰å¾…æ ¡å‡†...";
            
            swal('åœæ­¢æˆåŠŸ', `çœ¼åŠ¨è¿½è¸ªå·²åœæ­¢ã€‚æœ¬æ¬¡ä¼šè¯å…±æ”¶é›† ${gazeCount} ä¸ªæ³¨è§†ç‚¹ã€‚`, 'success');
        }

        // ===========================================
        // ç”Ÿå‘½å‘¨æœŸå’Œé”™è¯¯å¤„ç†
        // ===========================================
        window.addEventListener('load', initializeSystem);

        window.addEventListener('error', (e) => debug(`å…¨å±€é”™è¯¯: ${e.message}`));
        window.addEventListener('unhandledrejection', (e) => debug(`æœªå¤„ç†çš„Promiseæ‹’ç»: ${e.reason}`));

        // é¡µé¢å…³é—­å‰ä¿å­˜æ•°æ® - [ä¿®æ­£] sendBeaconç›´æ¥è°ƒç”¨Firestore APIä¼šå› CORSå’ŒAuthå¤±è´¥ï¼Œå·²æ³¨é‡Šæ‰ã€‚
        // å¯é çš„å®ç°éœ€è¦ä¸€ä¸ªåç«¯ä»£ç†ï¼ˆå¦‚Cloud Functionï¼‰ã€‚
        window.addEventListener('beforeunload', (e) => {
            if (isTracking && gazeCount > 0) {
                debug('é¡µé¢å³å°†å¸è½½ï¼Œæœ‰æœªä¿å­˜çš„æ•°æ®ã€‚');
                // navigator.sendBeacon(...) - æ­¤å¤„é€»è¾‘å·²ç§»é™¤
                const message = 'æ‚¨æœ‰æœªä¿å­˜çš„çœ¼åŠ¨æ•°æ®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                e.returnValue = message;
                return message;
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && isTracking && webgazer) webgazer.pause();
            else if (document.visibilityState === 'visible' && isTracking && webgazer) webgazer.resume();
        });

        window.addEventListener('online', () => {
            debug('ç½‘ç»œè¿æ¥æ¢å¤');
            if (isTracking && !firebaseConnected) testFirebaseConnection();
        });

        window.addEventListener('offline', () => {
            debug('ç½‘ç»œè¿æ¥æ–­å¼€');
            updateFirebaseStatus('ç½‘ç»œæ–­å¼€', 'disconnected');
            firebaseConnected = false;
        });
    </script>
</body>
</html>
        
