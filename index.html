<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>眼动追踪数据收集系统</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyB6O5l6uZa-6sywCZTGRJx2CKPuq3KeBF0",
            authDomain: "index-9f58d.firebaseapp.com",
            projectId: "index-9f58d",
            storageBucket: "index-9f58d.firebasestorage.app",
            messagingSenderId: "718279245978",
            appId: "1:718279245978:web:93a9a07473ad8d3e6a5f23"
        };
        
        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // 确保变量不为 undefined
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const userId = 'jingtianwei2002';
        console.log('会话ID:', sessionId);
        console.log('用户ID:', userId);

        // 动态加载WebGazer
        async function loadWebGazerScript() {
            const sources = [
                'https://webgazer.cs.brown.edu/webgazer.js',
                'https://unpkg.com/webgazer@2.0.2/dist/webgazer.js'
            ];

            for (const source of sources) {
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = source;
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`无法从 ${source} 加载WebGazer`));
                        document.head.appendChild(script);
                    });
                    console.log(`WebGazer从 ${source} 加载成功`);
                    return true;
                } catch (error) {
                    console.error(`加载失败: ${error.message}`);
                }
            }
            return false;
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #heatmapContainer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: -1000;
            opacity: 0.7;
            display: none;
        }
        
        #plotting_canvas {
            position: fixed;
            top: 0;
            left: 0;
            cursor: crosshair;
            z-index: 900;
            pointer-events: none;
        }
        
        #content { 
            position: relative; 
            z-index: 1; 
            padding: 50px; 
            max-width: 800px;
            margin: 0 auto;
            background: white;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #statsPanel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 2000;
            width: 280px;
            font-size: 12px;
        }
        
        .stat-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .stat-value {
            font-weight: bold;
            color: #4CAF50;
        }
        
        #debugPanel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            z-index: 2000;
            max-width: 350px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .test-area {
            height: 150px;
            margin: 30px 0;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-area:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .area-blue { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; }
        .area-green { background: linear-gradient(135deg, #00b894, #00a085); color: white; }
        .area-orange { background: linear-gradient(135deg, #fdcb6e, #e17055); color: white; }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover { background: #45a049; }
        .btn.danger { background: #f44336; }
        .btn.danger:hover { background: #da190b; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn.test { background: #2196F3; }
        .btn.test:hover { background: #1976D2; }
        .btn.toggle { background: #FF9800; }
        .btn.toggle:hover { background: #F57C00; }
        
        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 2000;
        }
        
        .status.ready { background: #4CAF50; color: white; }
        .status.calibrating { background: #ff9800; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.initializing { background: #2196F3; color: white; }
        .status.loading { background: #9C27B0; color: white; }
        
        .loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            z-index: 3000;
            transition: width 0.3s ease;
        }
        
        #webgazerVideoContainer {
            position: fixed !important;
            top: 10px !important;
            right: 320px !important;
            z-index: 1999 !important;
            width: 240px !important;
            height: 180px !important;
        }
        
        #webgazerVideoFeed {
            width: 100% !important;
            height: 100% !important;
            border-radius: 8px !important;
            border: 2px solid #4CAF50 !important;
        }
        
        /* 修复校准点样式 */
        .Calibration {
            width: 25px !important;
            height: 25px !important;
            border-radius: 50% !important;
            background-color: #ff0000 !important;
            border: 3px solid #000000 !important;
            position: fixed !important;
            z-index: 100000 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            opacity: 0.9 !important;
        }
        
        .Calibration:hover {
            transform: scale(1.3) !important;
            background-color: #ff4444 !important;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8) !important;
        }
        
        .Calibration.clicked {
            background-color: #ffff00 !important;
            border-color: #ff8800 !important;
            transform: scale(0.8) !important;
        }
        
        /* 校准点位置 */
        #Pt1 { top: 10% !important; left: 10% !important; }
        #Pt2 { top: 10% !important; left: 50% !important; margin-left: -12px !important; }
        #Pt3 { top: 10% !important; right: 10% !important; }
        #Pt4 { top: 50% !important; margin-top: -12px !important; left: 10% !important; }
        #Pt5 { top: 50% !important; margin-top: -12px !important; left: 50% !important; margin-left: -12px !important; }
        #Pt6 { top: 50% !important; margin-top: -12px !important; right: 10% !important; }
        #Pt7 { bottom: 10% !important; left: 10% !important; }
        #Pt8 { bottom: 10% !important; left: 50% !important; margin-left: -12px !important; }
        #Pt9 { bottom: 10% !important; right: 10% !important; }
        
        #Accuracy {
            background-color: #222;
            color: white;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        .collection-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }
        .collection-status.connected { background: #4CAF50; color: white; }
        .collection-status.disconnected { background: #f44336; color: white; }
        .collection-status.uploading { background: #ff9800; color: white; }

        .firebase-status {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }

        .heatmap-visible {
            opacity: 0.7 !important;
            display: block !important;
        }
    </style>
</head>
<body>
    <div id="loadingBar" class="loading-bar"></div>
    <div id="status" class="status loading">正在加载库文件...</div>
    <canvas id="plotting_canvas" width="500" height="500"></canvas>

    <div id="statsPanel">
        <h4 style="margin: 0 0 10px 0; text-align: center; color: #4CAF50;">📊 眼动数据统计</h4>
        <div class="stat-item">
            <span>会话ID:</span>
            <span id="sessionIdDisplay" class="stat-value" style="font-size: 10px; word-break: break-all;"></span>
        </div>
        <div class="stat-item">
            <span>注视点总数:</span>
            <span id="totalGazes" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>眼跳次数:</span>
            <span id="saccadeCount" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>注视次数:</span>
            <span id="fixationCount" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>平均注视时间:</span>
            <span id="avgFixationTime" class="stat-value">0ms</span>
        </div>
        <div class="stat-item">
            <span>热力图快照:</span>
            <span id="heatmapSnapshots" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>数据快照数:</span>
            <span id="snapshotCount" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>运行时间:</span>
            <span id="runningTime" class="stat-value">0s</span>
        </div>
        <div id="Accuracy">等待校准...</div>
        <div class="stat-item">
            <span>系统状态:</span>
            <span id="systemStatus" class="stat-value">加载中</span>
        </div>
        <div class="collection-status disconnected" id="collectionStatus">
            📈 数据收集: 未开始
        </div>
        <div class="firebase-status disconnected" id="firebaseStatus">
            🔥 Firebase: 未连接
        </div>
        
        <button class="btn test" onclick="testFirebaseConnection()" style="width: 100%; margin: 8px 0 0 0; padding: 6px; font-size: 12px;">
            🧪 测试连接
        </button>
        <button class="btn test" onclick="forceSaveData()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">
            💾 强制保存
        </button>
        <button class="btn toggle" onclick="toggleHeatmap()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">
            🔥 显示热力图
        </button>
        <button class="btn test" onclick="toggleDebug()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">
            🐛 显示调试
        </button>
    </div>

    <div id="debugPanel">
        <div id="debugInfo">调试信息将在这里显示...</div>
    </div>

    <div id="heatmapContainer"></div>

    <!-- 修复校准点HTML结构 -->
    <div class="calibrationDiv">
        <div class="Calibration" id="Pt1" style="display: none;"></div>
        <div class="Calibration" id="Pt2" style="display: none;"></div>
        <div class="Calibration" id="Pt3" style="display: none;"></div>
        <div class="Calibration" id="Pt4" style="display: none;"></div>
        <div class="Calibration" id="Pt5" style="display: none;"></div>
        <div class="Calibration" id="Pt6" style="display: none;"></div>
        <div class="Calibration" id="Pt7" style="display: none;"></div>
        <div class="Calibration" id="Pt8" style="display: none;"></div>
        <div class="Calibration" id="Pt9" style="display: none;"></div>
    </div>

    <div id="content">
        <h1 style="text-align: center; color: #333;">👁️ 眼动追踪数据收集系统</h1>
        
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startEyeTracking()" disabled>🚀 启动眼动追踪</button>
            <button class="btn" id="calibrateBtn" onclick="PopUpInstruction()" disabled>🎯 开始校准</button>
            <button class="btn" onclick="Restart()">🔄 重新校准</button>
            <button class="btn" onclick="exportData()">📊 导出数据</button>
            <button class="btn danger" onclick="stopTracking()">⏹️ 停止追踪</button>
        </div>
        
        <p style="text-align: center; font-size: 18px; color: #666; margin: 30px 0;">
            👀 请自然地浏览下面的内容，系统会收集您的眼动数据
        </p>
        
        <div class="test-area area-blue" onclick="debug('点击了蓝色区域')">
            <h2>🌊 区域 A - 海洋蓝</h2>
            <p>这是第一个测试区域。请尝试注视这里几秒钟，系统会记录您的注视点坐标、注视时间和眼动模式。</p>
        </div>
        
        <div class="test-area area-green" onclick="debug('点击了绿色区域')">
            <h2>🌿 区域 B - 森林绿</h2>
            <p>这是第二个测试区域。在不同区域之间移动视线会产生眼跳数据，包括移动距离和速度。</p>
        </div>
        
        <div class="test-area area-orange" onclick="debug('点击了橙色区域')">
            <h2>🔥 区域 C - 夕阳橙</h2>
            <p>这是第三个测试区域。长时间注视会生成注视数据，包括注视位置和持续时间。系统每秒会生成一张热力图快照保存到云端。</p>
        </div>
        
        <div style="text-align: center; margin: 40px 0; padding: 20px; background: #e8f5e8; border-radius: 8px;">
            <h4 style="color: #2e7d32; margin-bottom: 15px;">📋 使用说明</h4>
            <p style="margin: 8px 0; color: #555;">1. 点击"启动眼动追踪"开始收集数据</p>
            <p style="margin: 8px 0; color: #555;">2. 可选择完成9点校准提高精度</p>
            <p style="margin: 8px 0; color: #555;">3. 自然浏览页面，数据自动保存到云端</p>
            <p style="margin: 8px 0; color: #555;">4. 点击"显示热力图"可查看实时热力图</p>
        </div>
    </div>

    <script>
        // ===========================================
        // 全局变量定义
        // ===========================================
        let heatmapInstance = null;
        let gazeCount = 0;
        let snapshotCount = 0;
        let heatmapSnapshotCount = 0;
        let saccadeCount = 0;
        let fixationCount = 0;
        let totalFixationTime = 0;
        let startTime = Date.now();
        let isTracking = false;
        let webgazerReady = false;
        let debugMode = false;
        let heatmapVisible = false;
        let librariesLoaded = false;
        let firebaseConnected = false;
        
        // 校准相关变量
        var PointCalibrate = 0;
        var CalibrationPoints = {};
        var isStoring = false;
        var storedPoints = {x: [], y: []};

        // 眼动数据结构
        let eyeTrackingData = {
            gazePoints: [],
            saccades: [],
            fixations: [],
            heatmapSnapshots: []
        };

        // 用于眼跳和注视检测的变量
        let lastGazePoint = null;
        let currentFixation = null;
        let fixationThreshold = 50; // 像素阈值
        let fixationTimeThreshold = 100; // 毫秒阈值

        let autoSaveInterval = null;
        let heatmapSnapshotInterval = null;

        // 显示会话ID
        if (document.getElementById('sessionIdDisplay')) {
            document.getElementById('sessionIdDisplay').textContent = sessionId;
        }

        // ===========================================
        // 核心函数
        // ===========================================
        function debug(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[DEBUG ${timestamp}] ${message}`);
            
            if (debugMode && document.getElementById('debugInfo')) {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML = `[${timestamp}] ${message}<br>` + debugDiv.innerHTML;
                const lines = debugDiv.innerHTML.split('<br>');
                if (lines.length > 30) {
                    debugDiv.innerHTML = lines.slice(0, 30).join('<br>');
                }
            }
        }

        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
            }
            debug(`状态更新: ${message}`);
        }

        function updateFirebaseStatus(message, status) {
            const statusElement = document.getElementById('firebaseStatus');
            if (statusElement) {
                statusElement.textContent = `🔥 Firebase: ${message}`;
                statusElement.className = `firebase-status ${status}`;
            }
        }

        function updateCollectionStatus(message, status) {
            const statusElement = document.getElementById('collectionStatus');
            if (statusElement) {
                statusElement.textContent = `📈 数据收集: ${message}`;
                statusElement.className = `collection-status ${status}`;
            }
        }

        // ===========================================
        // Firebase 函数
        // ===========================================
        async function testFirebaseConnection() {
            debug('开始测试Firebase连接...');
            updateFirebaseStatus('测试中...', 'uploading');
            try {
                const testDoc = {
                    sessionId: sessionId,
                    userId: userId,
                    timestamp: new Date().toISOString(),
                    testType: 'connection_test'
                };
                
                // 验证数据完整性
                for (const key in testDoc) {
                    if (testDoc[key] === undefined || testDoc[key] === null) {
                        throw new Error(`测试数据字段 '${key}' 为 undefined 或 null`);
                    }
                }
                
                await db.collection("connection_test").add(testDoc);
                debug('Firebase连接测试成功！');
                updateFirebaseStatus('连接正常', 'connected');
                firebaseConnected = true;
                swal('成功', 'Firebase连接测试成功！', 'success');
                return true;
            } catch (error) {
                console.error("Firebase Connection Test Failed: ", error);
                debug(`Firebase连接测试失败: ${error.message}`);
                updateFirebaseStatus('连接失败', 'disconnected');
                firebaseConnected = false;
                swal('失败', `Firebase连接测试失败！\n\n${error.message}`, 'error');
                return false;
            }
        }

        async function forceSaveData() {
            if (!isTracking) {
                swal('提示', '请先启动眼动追踪再保存数据。', 'info');
                return;
            }
            await saveEyeTrackingData(true);
        }
        
        // ===========================================
        // 眼动数据处理 - 核心改进
        // ===========================================
        function gazeDataCallback(data, elapsedTime) {
            if (!isTracking || data == null || typeof data.x !== 'number' || typeof data.y !== 'number') {
                return;
            }
            
            if (isNaN(data.x) || isNaN(data.y) || data.x < 0 || data.y < 0) {
                return;
            }

            if (isStoring) {
                storedPoints.x.push(data.x);
                storedPoints.y.push(data.y);
            }
            
            const timestamp = new Date().toISOString();
            let gazePoint = {
                x: Math.floor(data.x),
                y: Math.floor(data.y),
                timestamp: timestamp,
                elapsedTime: elapsedTime || Date.now() - startTime
            };

            // 处理眼跳和注视检测
            processSaccadeAndFixation(gazePoint);

            eyeTrackingData.gazePoints.push(gazePoint);
            if (heatmapInstance) {
                heatmapInstance.addData({ x: gazePoint.x, y: gazePoint.y, value: 5 });
            }
            gazeCount++;
            updateStatsDisplay();
        }

        function processSaccadeAndFixation(gazePoint) {
            if (!lastGazePoint) {
                lastGazePoint = gazePoint;
                currentFixation = {
                    startPoint: {...gazePoint},
                    endPoint: {...gazePoint},
                    startTime: gazePoint.timestamp,
                    duration: 0,
                    pointCount: 1
                };
                return;
            }

            const distance = Math.sqrt(
                Math.pow(gazePoint.x - lastGazePoint.x, 2) + 
                Math.pow(gazePoint.y - lastGazePoint.y, 2)
            );

            if (distance > fixationThreshold) {
                // 检测到眼跳
                if (currentFixation && currentFixation.pointCount > 1) {
                    // 保存当前注视
                    const fixationDuration = new Date(gazePoint.timestamp).getTime() - new Date(currentFixation.startTime).getTime();
                    if (fixationDuration > fixationTimeThreshold) {
                        currentFixation.endTime = lastGazePoint.timestamp;
                        currentFixation.duration = fixationDuration;
                        currentFixation.endPoint = {...lastGazePoint};
                        
                        eyeTrackingData.fixations.push({...currentFixation});
                        fixationCount++;
                        totalFixationTime += fixationDuration;
                    }
                }

                // 记录眼跳
                const saccade = {
                    startPoint: {...lastGazePoint},
                    endPoint: {...gazePoint},
                    distance: distance,
                    startTime: lastGazePoint.timestamp,
                    endTime: gazePoint.timestamp,
                    duration: new Date(gazePoint.timestamp).getTime() - new Date(lastGazePoint.timestamp).getTime(),
                    velocity: distance / Math.max(1, new Date(gazePoint.timestamp).getTime() - new Date(lastGazePoint.timestamp).getTime()) * 1000 // px/s
                };
                
                eyeTrackingData.saccades.push(saccade);
                saccadeCount++;

                // 开始新的注视
                currentFixation = {
                    startPoint: {...gazePoint},
                    endPoint: {...gazePoint},
                    startTime: gazePoint.timestamp,
                    duration: 0,
                    pointCount: 1
                };
            } else {
                // 继续当前注视
                if (currentFixation) {
                    currentFixation.endPoint = {...gazePoint};
                    currentFixation.pointCount++;
                }
            }

            lastGazePoint = gazePoint;
        }

        function updateStatsDisplay() {
            document.getElementById('totalGazes').textContent = gazeCount;
            document.getElementById('saccadeCount').textContent = saccadeCount;
            document.getElementById('fixationCount').textContent = fixationCount;
            document.getElementById('heatmapSnapshots').textContent = heatmapSnapshotCount;
            
            const avgTime = fixationCount > 0 ? Math.round(totalFixationTime / fixationCount) : 0;
            document.getElementById('avgFixationTime').textContent = avgTime + 'ms';
        }
        
        // ===========================================
        // 热力图快照功能 - 修复版本
        // ===========================================
        function startHeatmapSnapshots() {
            if (heatmapSnapshotInterval) clearInterval(heatmapSnapshotInterval);
            
            heatmapSnapshotInterval = setInterval(() => {
                if (heatmapInstance && isTracking) {
                    captureHeatmapSnapshot();
                }
            }, 1000); // 每秒一张快照
            
            debug('热力图快照功能已启动 (每秒)');
        }

        function stopHeatmapSnapshots() {
            if (heatmapSnapshotInterval) {
                clearInterval(heatmapSnapshotInterval);
                heatmapSnapshotInterval = null;
            }
            debug('热力图快照功能已停止');
        }

        function captureHeatmapSnapshot() {
            try {
                // 确保热力图容器存在且可见
                const heatmapContainer = document.getElementById('heatmapContainer');
                const canvas = heatmapContainer.querySelector('canvas');
                
                if (canvas && heatmapInstance) {
                    // 强制重绘热力图
                    heatmapInstance.repaint();
                    
                    // 等待一小段时间确保渲染完成
                    setTimeout(() => {
                        try {
                            const dataURL = canvas.toDataURL('image/png');
                            const snapshot = {
                                timestamp: new Date().toISOString(),
                                imageData: dataURL,
                                gazePointsCount: gazeCount,
                                snapshotIndex: heatmapSnapshotCount + 1,
                                width: canvas.width,
                                height: canvas.height
                            };
                            
                            eyeTrackingData.heatmapSnapshots.push(snapshot);
                            heatmapSnapshotCount++;
                            debug(`热力图快照 #${heatmapSnapshotCount} 已保存 (${gazeCount} 个注视点)`);
                            updateStatsDisplay();
                        } catch (error) {
                            debug(`热力图快照保存失败: ${error.message}`);
                        }
                    }, 100);
                } else {
                    debug('热力图画布未找到，跳过快照');
                }
            } catch (error) {
                debug(`热力图快照捕获失败: ${error.message}`);
            }
        }
        
        // ===========================================
        // 自动保存
        // ===========================================
        function startAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            
            autoSaveInterval = setInterval(() => saveEyeTrackingData(false), 15000); // 15秒保存一次
            
            updateCollectionStatus('进行中 (自动保存)', 'connected');
            debug('自动保存已启动 (每15秒)');
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            updateCollectionStatus('已停止', 'disconnected');
            debug('自动保存已停止');
        }

        async function saveEyeTrackingData(isManual = false) {
            if (!firebaseConnected) {
                if(isManual) swal('错误', 'Firebase未连接，无法保存数据。', 'error');
                return;
            }
            
            const totalDataPoints = eyeTrackingData.gazePoints.length + 
                                  eyeTrackingData.saccades.length + 
                                  eyeTrackingData.fixations.length + 
                                  eyeTrackingData.heatmapSnapshots.length;
                                  
            if (totalDataPoints === 0) {
                debug('没有新数据需要保存');
                if(isManual) swal('提示', '没有新的眼动数据可供保存。', 'info');
                return;
            }

            const dataToSave = JSON.parse(JSON.stringify(eyeTrackingData)); // 深拷贝

            // 创建完整的数据载荷
            const payload = {
                sessionId: sessionId,
                userId: userId,
                timestamp: new Date().toISOString(),
                dataType: isManual ? 'manual_save' : 'auto_save',
                statistics: {
                    totalGazePoints: dataToSave.gazePoints.length,
                    totalSaccades: dataToSave.saccades.length,
                    totalFixations: dataToSave.fixations.length,
                    totalHeatmapSnapshots: dataToSave.heatmapSnapshots.length,
                    averageFixationTime: fixationCount > 0 ? Math.round(totalFixationTime / fixationCount) : 0,
                    sessionDuration: Date.now() - startTime
                },
                gazeData: dataToSave.gazePoints,
                saccadeData: dataToSave.saccades,
                fixationData: dataToSave.fixations,
                heatmapData: dataToSave.heatmapSnapshots
            };

            // 数据完整性检查
            for (const key in payload) {
                if (payload[key] === undefined || payload[key] === null) {
                    debug(`数据保存失败：字段 '${key}' 的值是 undefined 或 null。已阻止本次保存。`);
                    updateCollectionStatus('保存失败(数据错误)', 'disconnected');
                    if (isManual) {
                        swal('保存失败', `数据错误：字段 '${key}' 未定义或为空，无法保存。`, 'error');
                    }
                    return;
                }
            }

            updateCollectionStatus('保存中...', 'uploading');
            try {
                const docRef = await db.collection("eye_tracking_comprehensive").add(payload);
                
                snapshotCount++;
                document.getElementById('snapshotCount').textContent = snapshotCount;
                
                // 清空已保存的数据
                eyeTrackingData.gazePoints = [];
                eyeTrackingData.saccades = [];
                eyeTrackingData.fixations = [];
                eyeTrackingData.heatmapSnapshots = [];
                
                updateCollectionStatus('进行中 (自动保存)', 'connected');
                debug(`完整数据快照 #${snapshotCount} 保存成功 (ID: ${docRef.id})`);
                if(isManual) swal('成功', `完整数据已保存！\n注视点: ${payload.gazeData.length}\n眼跳: ${payload.saccadeData.length}\n注视: ${payload.fixationData.length}\n热力图: ${payload.heatmapData.length}`, 'success');

            } catch (error) {
                console.error("Firebase Save Failed: ", error);
                debug(`数据保存失败: ${error.message}`);
                updateCollectionStatus('保存失败', 'disconnected');
                if(isManual) swal('失败', `数据保存失败！\n\n${error.message}`, 'error');
                
                // 恢复数据
                eyeTrackingData.gazePoints = dataToSave.gazePoints.concat(eyeTrackingData.gazePoints);
                eyeTrackingData.saccades = dataToSave.saccades.concat(eyeTrackingData.saccades);
                eyeTrackingData.fixations = dataToSave.fixations.concat(eyeTrackingData.fixations);
                eyeTrackingData.heatmapSnapshots = dataToSave.heatmapSnapshots.concat(eyeTrackingData.heatmapSnapshots);
            }
        }

        // ===========================================
        // 工具函数
        // ===========================================
        function toggleDebug() {
            debugMode = !debugMode;
            const panel = document.getElementById('debugPanel');
            panel.style.display = debugMode ? 'block' : 'none';
        }

        function toggleHeatmap() {
            heatmapVisible = !heatmapVisible;
            const container = document.getElementById('heatmapContainer');
            container.classList.toggle('heatmap-visible');
            event.target.textContent = heatmapVisible ? '🔥 隐藏热力图' : '🔥 显示热力图';
        }

        function updateStats() {
            if (!isTracking) return;
            let elapsedSeconds = Math.round((Date.now() - startTime) / 1000);
            document.getElementById('runningTime').textContent = elapsedSeconds + 's';
        }

        function exportData() {
            if (gazeCount === 0) {
                swal('无数据', '没有收集到任何眼动数据可供导出。', 'warning');
                return;
            }
            const exportData = {
                sessionInfo: {
                    sessionId, 
                    userId,
                    exportTime: new Date().toISOString(),
                    sessionDuration: Date.now() - startTime
                },
                statistics: {
                    totalGazePoints: gazeCount,
                    totalSaccades: saccadeCount,
                    totalFixations: fixationCount,
                    totalHeatmapSnapshots: heatmapSnapshotCount,
                    averageFixationTime: fixationCount > 0 ? Math.round(totalFixationTime / fixationCount) : 0
                },
                collectedData: eyeTrackingData
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `eye-tracking-comprehensive-${sessionId}.json`;
            link.click();
            URL.revokeObjectURL(url);
            debug(`完整数据已导出为JSON文件`);
        }

        // ===========================================
        // 系统初始化和控制
        // ===========================================
        async function initializeSystem() {
            debug('页面及所有资源加载完成，开始系统初始化...');
            const startBtn = document.getElementById('startBtn');
            try {
                updateStatus('检查库文件...', 'loading');
                if (typeof h337 === 'undefined' || typeof swal === 'undefined') {
                    throw new Error('Heatmap.js或SweetAlert库加载失败。');
                }
                await loadWebGazerScript();
                if(typeof webgazer === 'undefined') {
                    throw new Error('WebGazer库加载失败。');
                }
                debug('所有库文件加载成功。');

                heatmapInstance = h337.create({
                    container: document.getElementById('heatmapContainer'),
                    radius: 20, 
                    maxOpacity: .6, 
                    minOpacity: .1, 
                    blur: .8
                });
                debug('热力图初始化完成。');
                
                // 立即测试热力图功能
                debug('测试热力图功能...');
                heatmapInstance.addData({x: 100, y: 100, value: 10});
                
                await testFirebaseConnection();

                updateStatus('点击启动按钮开始', 'ready');
                startBtn.disabled = false;
                debug('系统准备就绪');
                
            } catch (error) {
                console.error("Initialization failed: ", error);
                debug(`初始化过程出错: ${error.message}`);
                updateStatus('初始化失败', 'error');
                swal('严重错误', `系统初始化时发生错误: ${error.message}`, 'error');
            }
        }

        async function startEyeTracking() {
            const startBtn = document.getElementById('startBtn');
            const calibrateBtn = document.getElementById('calibrateBtn');
            startBtn.disabled = true;
            startBtn.textContent = '🔄 初始化中...';
            updateStatus('初始化 WebGazer...', 'initializing');

            try {
                await webgazer.setRegression('ridge').setGazeListener(gazeDataCallback).begin();
                webgazer.showVideoPreview(true).showPredictionPoints(true).applyKalmanFilter(true);
                
                isTracking = true;
                startTime = Date.now();
                
                // 启动数据收集功能
                if (firebaseConnected) {
                    startAutoSave();
                } else {
                    debug('Firebase未连接，数据将仅在本地累计');
                    updateCollectionStatus('本地收集中', 'uploading');
                }
                
                startHeatmapSnapshots(); // 启动热力图快照
                
                updateStatus('数据收集中', 'ready');
                calibrateBtn.disabled = false;
                startBtn.textContent = '✅ 收集中';
                debug('眼动追踪已启动 - 包含完整数据收集功能');
                
            } catch (error) {
                debug(`启动失败: ${error.message}`);
                updateStatus('启动失败', 'error');
                startBtn.disabled = false;
                startBtn.textContent = '🔄 重试启动';
                swal('启动失败', `无法启动眼动追踪。\n请确保已授权摄像头访问权限。\n\n错误: ${error.message}`, 'error');
            }
        }

        function stopTracking() {
            if (!isTracking) return;
            
            // 保存最终数据
            saveEyeTrackingData(true);

            isTracking = false;
            stopAutoSave();
            stopHeatmapSnapshots();
            
            try {
                if (typeof webgazer !== 'undefined' && webgazer.isReady()) {
                    webgazer.end();
                    debug('WebGazer已停止');
                }
            } catch (error) {
                debug(`停止WebGazer时出错: ${error.message}`);
            }
            
            updateStatus('数据收集已停止', 'error');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = '🚀 启动眼动追踪';
            document.getElementById('calibrateBtn').disabled = true;
            
            ClearCalibration();
            debug('眼动追踪已停止');
        }

        // ===========================================
        // 校准函数 - 完全重写修复
        // ===========================================
        function ClearCanvas() { 
            document.querySelectorAll('.Calibration').forEach(i => {
                i.style.display = 'none';
                i.classList.remove('clicked');
            }); 
        }
        
        function PopUpInstruction() { 
            if (!isTracking) { 
                swal('提示', '请先启动眼动追踪再进行校准。', 'info'); 
                return; 
            } 
            ClearCanvas(); 
            swal({ 
                title:"校准提示", 
                text: "请依次点击屏幕上的9个红点进行校准。点击确定开始校准。", 
                buttons:{ 
                    cancel: "取消",
                    confirm: "开始校准" 
                } 
            }).then(isConfirm => { 
                if(isConfirm) {
                    ShowCalibrationPoint(); 
                }
            }); 
        }
        
        // 重新绑定事件处理器
        function setupCalibrationEvents() {
            for (let i = 1; i <= 9; i++) {
                const point = document.getElementById('Pt' + i);
                if (point) {
                    // 移除旧的事件监听器
                    point.onclick = null;
                    // 添加新的事件监听器
                    point.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        calPointClick(this);
                    });
                    debug(`校准点 Pt${i} 事件已绑定`);
                }
            }
        }
        
        function calPointClick(node) { 
            if (!isTracking) {
                debug('眼动追踪未启动，忽略校准点击');
                return;
            }
            
            const id = node.id; 
            debug(`校准点 ${id} 被点击`);
            
            if (!CalibrationPoints[id]){ 
                CalibrationPoints[id] = 0; 
            } 
            CalibrationPoints[id]++; 
            
            if (CalibrationPoints[id] == 1){ 
                node.style.backgroundColor = '#ffff00';
                node.classList.add('clicked');
                node.style.pointerEvents = 'none'; // 禁用进一步点击
                PointCalibrate++; 
                debug(`校准进度: ${PointCalibrate}/9`);
                
                // WebGazer校准点击
                if (typeof webgazer !== 'undefined' && webgazer.isReady()) {
                    webgazer.watchListener(node, true);
                }
            } 
            
            if (PointCalibrate == 8){ 
                document.getElementById('Pt5').style.display = 'block'; 
                debug('显示第9个校准点');
            } 
            
            if (PointCalibrate >= 9){ 
                debug('校准完成，开始精度测试');
                setTimeout(() => {
                    ClearCanvas(); 
                    calcAccuracy(); 
                }, 500);
            } 
        }
        
        function ShowCalibrationPoint() { 
            PointCalibrate = 0;
            CalibrationPoints = {};
            debug('开始显示校准点');
            
            document.querySelectorAll('.Calibration').forEach(i => { 
                i.style.display = 'block'; 
                i.style.backgroundColor = '#ff0000';
                i.classList.remove('clicked');
                i.style.pointerEvents = 'auto';
            }); 
            document.getElementById('Pt5').style.display = 'none'; 
            
            // 重新绑定事件
            setupCalibrationEvents();
            
            debug('校准点已显示，请依次点击校准');
        }
        
        function ClearCalibration() { 
            if (typeof webgazer !== 'undefined' && webgazer.isReady()) {
                webgazer.clearData(); 
                debug('WebGazer校准数据已清除');
            }
            document.querySelectorAll('.Calibration').forEach(i => { 
                i.style.backgroundColor = '#ff0000'; 
                i.classList.remove('clicked');
                i.style.display = 'none';
                i.style.pointerEvents = 'auto';
            }); 
            CalibrationPoints = {}; 
            PointCalibrate = 0; 
        }
        
        function sleep (time) { 
            return new Promise(resolve => setTimeout(resolve, time)); 
        }
        
        function Restart() { 
            if (!isTracking) { 
                swal('提示', '请先启动眼动追踪。', 'info'); 
                return; 
            } 
            document.getElementById("Accuracy").innerHTML = "等待校准..."; 
            ClearCalibration(); 
            PopUpInstruction(); 
        }
        
        function calcAccuracy() { 
            swal({ 
                title: "测量精度中", 
                text: "请不要移动鼠标，并凝视屏幕中央5秒钟。", 
                closeOnEsc: false, 
                allowOutsideClick: false, 
                closeModal: true 
            }).then(() => { 
                isStoring = true; 
                storedPoints = {x: [], y: []}; 
                debug('开始收集精度测试数据...');
                sleep(5000).then(() => { 
                    isStoring = false; 
                    var past50 = [storedPoints.x, storedPoints.y]; 
                    var precision = calculatePrecision(past50); 
                    document.getElementById("Accuracy").innerHTML = `精度 | ${precision}%`; 
                    debug(`校准精度测试完成: ${precision}%`);
                    swal({ 
                        title: `您的精度测量结果是 ${precision}%`, 
                        text: `收集了 ${storedPoints.x.length} 个测试点`,
                        buttons: { 
                            cancel: "重新校准", 
                            confirm: "继续" 
                        } 
                    }).then(isConfirm => { 
                        if (!isConfirm) Restart(); 
                    }); 
                }); 
            }); 
        }
        
        function calculatePrecision(past50Array) { 
            var x50 = past50Array[0], y50 = past50Array[1]; 
            if (x50.length === 0) {
                debug('精度测试: 没有收集到数据点');
                return 0;
            }
            var staringPointX = window.innerWidth / 2, staringPointY = window.innerHeight / 2; 
            var distances = x50.map((x, i) => Math.sqrt(Math.pow(x - staringPointX, 2) + Math.pow(y50[i] - staringPointY, 2))); 
            var maxDistance = window.innerHeight / 2; 
            var percentages = distances.map(d => Math.max(0, 100 - (d / maxDistance * 100))); 
            var avgPrecision = percentages.reduce((a, b) => a + b, 0) / percentages.length; 
            debug(`精度计算: ${x50.length} 个点, 平均距离: ${distances.reduce((a,b) => a+b, 0)/distances.length}px`);
            return Math.round(avgPrecision); 
        }
        
        // ===========================================
        // 页面启动
        // ===========================================
        window.onload = function() {
            debug('页面加载完成，开始初始化...');
            initializeSystem();
            // 确保校准事件正确绑定
            setTimeout(setupCalibrationEvents, 1000);
        };
        
        window.onbeforeunload = () => { 
            if(isTracking) stopTracking(); 
        };
        
        setInterval(updateStats, 1000);
        window.addEventListener('error', e => debug(`全局错误: ${e.message}`));
        window.addEventListener('unhandledrejection', e => debug(`Promise错误: ${e.reason}`));
    </script>
</body>
</html>
