<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ¼åŠ¨è¿½è¸ªçƒ­åŠ›å›¾ - äº‘ç«¯æ•°æ®ç‰ˆ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase é…ç½® - è¯·æ›¿æ¢ä¸ºæ‚¨çš„Firebaseé¡¹ç›®é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyB6O5l6uZa-6sywCZTGRJx2CKPuq3KeBF0",
            authDomain: "index-9f58d.firebaseapp.com",
            projectId: "index-9f58d",
            storageBucket: "index-9f58d.firebasestorage.app",
            messagingSenderId: "718279245978",
            appId: "1:718279245978:web:93a9a07473ad8d3e6a5f23"
        };
     
        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ç”Ÿæˆå”¯ä¸€ä¼šè¯ID
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('ä¼šè¯ID:', sessionId);
    </script>
    
    <!-- ç¬¬ä¸‰æ–¹Cookieè­¦å‘Š -->
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            if (navigator.cookieEnabled && !document.cookie.includes('webgazer_cookie_consent')) {
                const cookieWarning = document.createElement('div');
                cookieWarning.style.cssText = 'position:fixed;top:0;left:0;width:100%;background:#ff9800;color:white;padding:12px;text-align:center;z-index:10000;font-weight:bold;';
                cookieWarning.innerHTML = 'âš ï¸ æ³¨æ„ï¼šWebGazeréœ€è¦å¯ç”¨ç¬¬ä¸‰æ–¹Cookieæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚è¯·ç¡®ä¿æ‚¨çš„æµè§ˆå™¨è®¾ç½®å…è®¸ç¬¬ä¸‰æ–¹Cookieï¼Œæˆ–ä½¿ç”¨Chromeæµè§ˆå™¨è·å¾—æœ€ä½³ä½“éªŒã€‚<button style="margin-left:15px;padding:5px 10px;background:white;border:none;border-radius:4px;cursor:pointer;">æˆ‘çŸ¥é“äº†</button>';
                document.body.appendChild(cookieWarning);
                
                cookieWarning.querySelector('button').onclick = function() {
                    document.cookie = "webgazer_cookie_consent=true;max-age=31536000;path=/";
                    cookieWarning.style.display = 'none';
                };
            }
        });

        // åŠ¨æ€åŠ è½½WebGazer
        async function loadWebGazerScript() {
            const sources = [
                './webgazer.js',  
                './lib/webgazer.js', 
                'https://webgazer.cs.brown.edu/webgazer.js',
                'https://unpkg.com/webgazer@2.0.2/dist/webgazer.js'
            ];

            for (const source of sources) {
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = source;
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`æ— æ³•ä» ${source} åŠ è½½WebGazer`));
                        document.head.appendChild(script);
                    });
                    console.log(`WebGazerä» ${source} åŠ è½½æˆåŠŸ`);
                    return true;
                } catch (error) {
                    console.error(`å°è¯•åŠ è½½å¤±è´¥: ${error.message}`);
                }
            }
            return false;
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    
    <!-- åŸæœ‰çš„CSSæ ·å¼ä¿æŒä¸å˜ -->
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #heatmapContainer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: 1000; 
        }
        
        #plotting_canvas {
            position: fixed;
            top: 0;
            left: 0;
            cursor: crosshair;
            z-index: 900;
            pointer-events: none;
        }
        
        #content { 
            position: relative; 
            z-index: 1; 
            padding: 50px; 
            max-width: 800px;
            margin: 0 auto;
            background: white;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #statsPanel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 2000;
            min-width: 250px;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .stat-value {
            font-weight: bold;
            color: #4CAF50;
        }
        
        #debugPanel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            z-index: 2000;
            max-width: 300px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .test-area {
            height: 150px;
            margin: 30px 0;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-area:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .area-blue { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; }
        .area-green { background: linear-gradient(135deg, #00b894, #00a085); color: white; }
        .area-orange { background: linear-gradient(135deg, #fdcb6e, #e17055); color: white; }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover { background: #45a049; }
        .btn.danger { background: #f44336; }
        .btn.danger:hover { background: #da190b; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 2000;
        }
        
        .status.ready { background: #4CAF50; color: white; }
        .status.calibrating { background: #ff9800; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.initializing { background: #2196F3; color: white; }
        .status.loading { background: #9C27B0; color: white; }
        
        .loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            z-index: 3000;
            transition: width 0.3s ease;
        }
        
        #webgazerVideoContainer {
            position: fixed !important;
            top: 10px !important;
            right: 10px !important;
            z-index: 9999 !important;
            width: 240px !important;
            height: 180px !important;
        }
        
        #webgazerVideoFeed {
            width: 100% !important;
            height: 100% !important;
            border-radius: 8px !important;
            border: 2px solid #4CAF50 !important;
        }
        
        #webgazerFaceFeedbackBox {
            border: 2px solid #4CAF50 !important;
        }
        
        .Calibration {
            width: 20px;
            height: 20px;
            -webkit-border-radius: 25px;
            -moz-border-radius: 25px;
            border-radius: 25px;
            background-color: red;
            opacity: 0.2;
            border-color: black;
            border-style: solid;
            position: fixed;
            z-index: 99999;
            cursor: pointer;
        }
        
        #Pt1 { top: 10%; left: 10%; }
        #Pt2 { top: 10%; left: 50%; margin-left: -10px; }
        #Pt3 { top: 10%; right: 10%; }
        #Pt4 { top: 50%; margin-top: -10px; left: 10%; }
        #Pt5 { top: 50%; margin-top: -10px; left: 50%; margin-left: -10px; }
        #Pt6 { top: 50%; margin-top: -10px; right: 10%; }
        #Pt7 { bottom: 10%; left: 10%; }
        #Pt8 { bottom: 10%; left: 50%; margin-left: -10px; }
        #Pt9 { bottom: 10%; right: 10%; }
        
        #Accuracy {
            background-color: #222;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }

        /* æ–°å¢ï¼šäº‘ç«¯æ•°æ®é¢æ¿æ ·å¼ */
        #cloudPanel {
            position: fixed;
            top: 20px;
            left: 280px;
            background: rgba(0,123,255,0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 2000;
            min-width: 200px;
            font-size: 14px;
        }

        .upload-btn {
            background: #28a745;
            margin-top: 10px;
        }
        .upload-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <!-- åŸæœ‰çš„UIå…ƒç´ ä¿æŒä¸å˜ -->
    <div id="loadingBar" class="loading-bar"></div>
    <div id="status" class="status loading">æ­£åœ¨åŠ è½½åº“æ–‡ä»¶...</div>
    <canvas id="plotting_canvas" width="500" height="500"></canvas>

    <!-- æ–°å¢ï¼šäº‘ç«¯æ•°æ®é¢æ¿ -->
    <div id="cloudPanel">
        <h3 style="margin-top: 0; color: #fff;">â˜ï¸ äº‘ç«¯æ•°æ®</h3>
        <div class="stat-item">
            <span>ä¼šè¯ID:</span>
            <span id="sessionIdDisplay" class="stat-value">åŠ è½½ä¸­...</span>
        </div>
        <div class="stat-item">
            <span>ä¸Šä¼ çŠ¶æ€:</span>
            <span id="uploadStatus" class="stat-value">å¾…ä¸Šä¼ </span>
        </div>
        <div class="stat-item">
            <span>å·²ä¸Šä¼ æ•°æ®:</span>
            <span id="uploadedCount" class="stat-value">0</span>
        </div>
        <button class="btn upload-btn" onclick="uploadCurrentData()">ğŸ“¤ ç«‹å³ä¸Šä¼ </button>
        <button class="btn upload-btn" onclick="viewCloudData()">ğŸ‘ï¸ æŸ¥çœ‹äº‘ç«¯æ•°æ®</button>
    </div>

    <!-- åŸæœ‰çš„é¢æ¿ä¿æŒä¸å˜ -->
    <div id="statsPanel">
        <h3 style="margin-top: 0; color: #4CAF50;">ğŸ“Š çœ¼åŠ¨æ•°æ®ç»Ÿè®¡</h3>
        <div class="stat-item">
            <span>æ³¨è§†ç‚¹æ€»æ•°:</span>
            <span id="totalGazes" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>å¹³å‡æ³¨è§†æ—¶é•¿:</span>
            <span id="avgDuration" class="stat-value">0ms</span>
        </div>
        <div class="stat-item">
            <span>çœ¼åŠ¨é¢‘ç‡:</span>
            <span id="gazeFrequency" class="stat-value">0 æ¬¡/ç§’</span>
        </div>
        <div class="stat-item">
            <span>è¿è¡Œæ—¶é—´:</span>
            <span id="runningTime" class="stat-value">0ç§’</span>
        </div>
        <div id="Accuracy">ç­‰å¾…æ ¡å‡†...</div>
        <div class="stat-item">
            <span>WebGazerçŠ¶æ€:</span>
            <span id="webgazerStatus" class="stat-value">åŠ è½½ä¸­</span>
        </div>
        <div class="stat-item">
            <span>åº“åŠ è½½çŠ¶æ€:</span>
            <span id="libraryStatus" class="stat-value">åŠ è½½ä¸­</span>
        </div>
    </div>

    <div id="debugPanel">
        <div id="debugInfo">è°ƒè¯•ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
    </div>

    <div id="heatmapContainer"></div>

    <!-- æ ¡å‡†ç‚¹å®¹å™¨ -->
    <div class="calibrationDiv">
        <input type="button" class="Calibration" id="Pt1" style="display: none;">
        <input type="button" class="Calibration" id="Pt2" style="display: none;">
        <input type="button" class="Calibration" id="Pt3" style="display: none;">
        <input type="button" class="Calibration" id="Pt4" style="display: none;">
        <input type="button" class="Calibration" id="Pt5" style="display: none;">
        <input type="button" class="Calibration" id="Pt6" style="display: none;">
        <input type="button" class="Calibration" id="Pt7" style="display: none;">
        <input type="button" class="Calibration" id="Pt8" style="display: none;">
        <input type="button" class="Calibration" id="Pt9" style="display: none;">
    </div>

    <!-- é¡µé¢å†…å®¹ -->
    <div id="content">
        <h1 style="text-align: center; color: #333;">ğŸ”¥ çœ¼åŠ¨è¿½è¸ªçƒ­åŠ›å›¾æ¼”ç¤º - äº‘ç«¯æ•°æ®ç‰ˆ</h1>
        
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startEyeTracking()">ğŸš€ å¯åŠ¨çœ¼åŠ¨è¿½è¸ª</button>
            <button class="btn" id="calibrateBtn" onclick="PopUpInstruction()" disabled>ğŸ¯ å¼€å§‹æ ¡å‡†</button>
            <button class="btn" onclick="Restart()">ğŸ”„ é‡æ–°æ ¡å‡†</button>
            <button class="btn" onclick="clearHeatmap()">ğŸ§¹ æ¸…é™¤çƒ­åŠ›å›¾</button>
            <button class="btn" onclick="exportData()">ğŸ“Š å¯¼å‡ºæ•°æ®</button>
            <button class="btn upload-btn" onclick="uploadCurrentData()">â˜ï¸ ä¸Šä¼ åˆ°äº‘ç«¯</button>
            <button class="btn" onclick="toggleDebug()">ğŸ› åˆ‡æ¢è°ƒè¯•</button>
            <button class="btn danger" onclick="stopTracking()">â¹ï¸ åœæ­¢è¿½è¸ª</button>
        </div>
        
        <p style="text-align: center; font-size: 18px; color: #666;">
            ğŸ‘€ è¯·çœ‹å‘ä¸‹é¢çš„ä¸åŒåŒºåŸŸï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•æ‚¨çš„çœ¼åŠ¨è½¨è¿¹å¹¶ç”Ÿæˆçƒ­åŠ›å›¾
        </p>
        
        <div class="test-area area-blue">
            <h2>ğŸŒŠ åŒºåŸŸ A - æµ·æ´‹è“</h2>
            <p>è¿™æ˜¯ç¬¬ä¸€ä¸ªæµ‹è¯•åŒºåŸŸã€‚è¯·å°è¯•æ³¨è§†è¿™é‡Œå‡ ç§’é’Ÿï¼Œè§‚å¯Ÿçƒ­åŠ›å›¾çš„å˜åŒ–ã€‚çƒ­åŠ›å›¾ä¼šæ˜¾ç¤ºæ‚¨æ³¨è§†æ—¶é—´æœ€é•¿çš„åŒºåŸŸã€‚</p>
        </div>
        
        <div class="test-area area-green">
            <h2>ğŸŒ¿ åŒºåŸŸ B - æ£®æ—ç»¿</h2>
            <p>è¿™æ˜¯ç¬¬äºŒä¸ªæµ‹è¯•åŒºåŸŸã€‚æ‚¨å¯ä»¥åœ¨ä¸åŒåŒºåŸŸä¹‹é—´ç§»åŠ¨è§†çº¿ï¼Œç³»ç»Ÿä¼šå®æ—¶è®°å½•æ‚¨çš„çœ¼åŠ¨æ¨¡å¼å’Œæ³¨è§†æ—¶é•¿ã€‚</p>
        </div>
        
        <div class="test-area area-orange">
            <h2>ğŸ”¥ åŒºåŸŸ C - å¤•é˜³æ©™</h2>
            <p>è¿™æ˜¯ç¬¬ä¸‰ä¸ªæµ‹è¯•åŒºåŸŸã€‚é•¿æ—¶é—´æ³¨è§†åŒä¸€ä½ç½®ä¼šåœ¨çƒ­åŠ›å›¾ä¸Šå½¢æˆ"çƒ­ç‚¹"ï¼Œé¢œè‰²è¶Šçº¢è¡¨ç¤ºæ³¨è§†æ—¶é—´è¶Šé•¿ã€‚</p>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 30px; border-left: 4px solid #007bff;">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼ˆäº‘ç«¯æ•°æ®ç‰ˆï¼‰ï¼š</h3>
            <ol>
                <li><strong>ç‚¹å‡»"å¯åŠ¨çœ¼åŠ¨è¿½è¸ª"</strong> - é¦–å…ˆå¯åŠ¨ç³»ç»Ÿ</li>
                <li><strong>å…è®¸æ‘„åƒå¤´æƒé™</strong> - æµè§ˆå™¨ä¼šè¯¢é—®æ‘„åƒå¤´æƒé™</li>
                <li><strong>ç­‰å¾…ç³»ç»Ÿå°±ç»ª</strong> - è§‚å¯Ÿå·¦ä¸Šè§’çŠ¶æ€æŒ‡ç¤ºå™¨</li>
                <li><strong>ç‚¹å‡»"å¼€å§‹æ ¡å‡†"</strong> - æŒ‰ç…§å¼¹çª—æç¤ºè¿›è¡Œæ ¡å‡†</li>
                <li><strong>ä¾æ¬¡ç‚¹å‡»9ä¸ªæ ¡å‡†ç‚¹</strong> - æ¯ä¸ªç‚¹éœ€è¦ç‚¹å‡»5æ¬¡ï¼Œçœ‹å‘è¯¥ç‚¹å†ç‚¹å‡»</li>
                <li><strong>ç­‰å¾…çœŸå®ç²¾åº¦è®¡ç®—</strong> - æ ¡å‡†å®Œæˆåä¼šè¿›è¡Œ5ç§’çš„çœŸå®ç²¾åº¦æµ‹é‡</li>
                <li><strong>è‡ªç„¶åœ°æµè§ˆé¡µé¢</strong> - çœ‹å‘ä¸åŒåŒºåŸŸï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•</li>
                <li><strong>è§‚å¯Ÿçƒ­åŠ›å›¾</strong> - çº¢è‰²åŒºåŸŸè¡¨ç¤ºæ³¨è§†æ—¶é—´é•¿çš„åœ°æ–¹</li>
                <li><strong>ä¸Šä¼ æ•°æ®åˆ°äº‘ç«¯</strong> - ç‚¹å‡»"ä¸Šä¼ åˆ°äº‘ç«¯"æŒ‰é’®ä¿å­˜æ•°æ®</li>
            </ol>
            <p style="color: #007bff; margin-top: 15px;"><strong>æ–°å¢åŠŸèƒ½ï¼š</strong> ç°åœ¨æ”¯æŒå°†çœ¼åŠ¨æ•°æ®ä¸Šä¼ åˆ°Firebaseäº‘ç«¯ï¼Œå®ç°å¤šç”¨æˆ·æ•°æ®æ”¶é›†ï¼</p>
        </div>
    </div>

    <script>
        // ===========================================
        // å…¨å±€å˜é‡å®šä¹‰ï¼ˆä¿æŒåŸæœ‰å˜é‡ï¼‰
        // ===========================================
        let heatmapInstance = null;
        let gazeCount = 0;
        let totalDuration = 0;
        let startTime = Date.now();
        let isTracking = false;
        let webgazerReady = false;
        let debugMode = true;
        let rawGazeCount = 0;
        let initializationAttempts = 0;
        let librariesLoaded = false;
        let lastGazeTime = 0;
        
        var PointCalibrate = 0;
        var CalibrationPoints = {};
        var isStoring = false;
        var storedPoints = {x: [], y: []};

        // æ–°å¢ï¼šäº‘ç«¯æ•°æ®ç›¸å…³å˜é‡
        let gazeDataArray = [];
        let calibrationData = {};
        let uploadedDataCount = 0;

        // åˆå§‹åŒ–æ˜¾ç¤ºä¼šè¯ID
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sessionIdDisplay').textContent = sessionId.substr(-8);
        });

        // ===========================================
        // æ–°å¢ï¼šäº‘ç«¯æ•°æ®åŠŸèƒ½
        // ===========================================
        
        /**
         * æ”¶é›†çœ¼åŠ¨æ•°æ®ç‚¹
         */
        function collectGazeData(x, y, timestamp, value) {
            gazeDataArray.push({
                x: x,
                y: y,
                timestamp: timestamp,
                value: value,
                sessionId: sessionId
            });
        }

        /**
         * ä¸Šä¼ å½“å‰æ•°æ®åˆ°Firebase
         */
        async function uploadCurrentData() {
            if (gazeDataArray.length === 0) {
                alert('æš‚æ— æ•°æ®å¯ä¸Šä¼ ï¼è¯·å…ˆè¿›è¡Œçœ¼åŠ¨è¿½è¸ªã€‚');
                return;
            }

            document.getElementById('uploadStatus').textContent = 'ä¸Šä¼ ä¸­...';
            
            try {
                const dataToUpload = {
                    sessionId: sessionId,
                    timestamp: new Date().toISOString(),
                    gazeData: gazeDataArray,
                    calibrationData: calibrationData,
                    stats: {
                        totalGazePoints: gazeCount,
                        averageDuration: gazeCount > 0 ? Math.round(totalDuration / gazeCount) : 0,
                        runningTime: Math.round((Date.now() - startTime) / 1000),
                        calibrationPoints: PointCalibrate,
                        accuracy: document.getElementById("Accuracy").innerHTML
                    },
                    userAgent: navigator.userAgent,
                    screenResolution: {
                        width: window.screen.width,
                        height: window.screen.height
                    },
                    windowSize: {
                        width: window.innerWidth,
                        height: window.innerHeight
                    }
                };

                const docRef = await db.collection("eye_tracking_sessions").add(dataToUpload);
                
                uploadedDataCount++;
                document.getElementById('uploadStatus').textContent = 'ä¸Šä¼ æˆåŠŸ';
                document.getElementById('uploadedCount').textContent = uploadedDataCount;
                
                debug(`æ•°æ®ä¸Šä¼ æˆåŠŸï¼Œæ–‡æ¡£ID: ${docRef.id}`);
                alert(`æ•°æ®ä¸Šä¼ æˆåŠŸï¼\næ–‡æ¡£ID: ${docRef.id}\nåŒ…å« ${gazeDataArray.length} ä¸ªæ³¨è§†ç‚¹æ•°æ®`);
                
                // æ¸…ç©ºå·²ä¸Šä¼ çš„æ•°æ®
                gazeDataArray = [];
                
            } catch (error) {
                document.getElementById('uploadStatus').textContent = 'ä¸Šä¼ å¤±è´¥';
                debug(`æ•°æ®ä¸Šä¼ å¤±è´¥: ${error.message}`);
                alert(`æ•°æ®ä¸Šä¼ å¤±è´¥: ${error.message}`);
            }
        }

        /**
         * æŸ¥çœ‹äº‘ç«¯æ•°æ®
         */
        async function viewCloudData() {
            try {
                const snapshot = await db.collection("eye_tracking_sessions")
                    .orderBy("timestamp", "desc")
                    .limit(10)
                    .get();
                
                let dataList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    dataList.push({
                        id: doc.id,
                        sessionId: data.sessionId,
                        timestamp: data.timestamp,
                        gazePointsCount: data.gazeData ? data.gazeData.length : 0,
                        accuracy: data.stats ? data.stats.accuracy : 'N/A'
                    });
                });

                if (dataList.length === 0) {
                    alert('äº‘ç«¯æš‚æ— æ•°æ®');
                    return;
                }

                let message = 'æœ€è¿‘10æ¡äº‘ç«¯æ•°æ®:\n\n';
                dataList.forEach((item, index) => {
                    message += `${index + 1}. ä¼šè¯: ${item.sessionId.substr(-8)}\n`;
                    message += `   æ—¶é—´: ${new Date(item.timestamp).toLocaleString('zh-CN')}\n`;
                    message += `   æ³¨è§†ç‚¹: ${item.gazePointsCount}\n`;
                    message += `   ç²¾åº¦: ${item.accuracy}\n\n`;
                });

                alert(message);
                
            } catch (error) {
                debug(`æŸ¥çœ‹äº‘ç«¯æ•°æ®å¤±è´¥: ${error.message}`);
                alert(`æŸ¥çœ‹äº‘ç«¯æ•°æ®å¤±è´¥: ${error.message}`);
            }
        }

        // ===========================================
        // ä¿®æ”¹åŸæœ‰çš„æ•°æ®æ”¶é›†å‡½æ•°
        // ===========================================
        function gazeDataCallback(data, elapsedTime) {
            rawGazeCount++;
            
            if (data == null || !isTracking) {
                return;
            }

            if (isStoring && data.x && data.y) {
                storedPoints.x.push(data.x);
                storedPoints.y.push(data.y);
            }
            
            let currentTime = Date.now();
            
            if (data.x < 0 || data.x > window.innerWidth || 
                data.y < 0 || data.y > window.innerHeight) {
                return;
            }
            
            let timeDiff = currentTime - lastGazeTime;
            if (lastGazeTime > 0 && timeDiff > 16 && timeDiff < 1000) {
                let point = {
                    x: Math.floor(data.x),
                    y: Math.floor(data.y),
                    value: Math.min(Math.max(timeDiff / 10, 1), 100)
                };
                
                heatmapInstance.addData(point);
                gazeCount++;
                totalDuration += timeDiff;

                // æ–°å¢ï¼šæ”¶é›†æ•°æ®åˆ°æ•°ç»„ä¸­
                collectGazeData(point.x, point.y, currentTime, point.value);
                
                if (gazeCount % 30 === 0) {
                    debug(`è®°å½•æ³¨è§†ç‚¹: ${gazeCount}, ä½ç½®: (${point.x}, ${point.y}), é—´éš”: ${timeDiff}ms`);
                }
            }
            
            lastGazeTime = currentTime;
        }

        // ===========================================
        // ä¿®æ”¹æ ¡å‡†å®Œæˆå‡½æ•°ï¼Œä¿å­˜æ ¡å‡†æ•°æ®
        // ===========================================
        function calcAccuracy() {
            swal({
                title: "Calculating measurement",
                text: "Please don't move your mouse & stare at the middle dot for the next 5 seconds. This will allow us to calculate the accuracy of our predictions.",
                closeOnEsc: false,
                allowOutsideClick: false,
                closeModal: true
            }).then( () => {
                debug('å¼€å§‹5ç§’ç²¾åº¦æµ‹é‡ï¼Œè¯·å‡è§†å±å¹•ä¸­å¿ƒ');
                
                store_points_variable();
                
                sleep(5000).then(() => {
                    stop_storing_points_variable();
                    var past50 = getStoredPoints();
                    
                    if (past50[0].length === 0) {
                        debug('è­¦å‘Šï¼šæœªæ”¶é›†åˆ°é¢„æµ‹ç‚¹ï¼Œä½¿ç”¨é»˜è®¤ç²¾åº¦');
                        var precision_measurement = 50;
                    } else {
                        var precision_measurement = calculatePrecision(past50);
                    }
                    
                    var accuracyLabel = "Accuracy | "+precision_measurement+"%";
                    document.getElementById("Accuracy").innerHTML = accuracyLabel;
                    debug(`ç²¾åº¦æµ‹é‡å®Œæˆ: ${precision_measurement}%`);

                    // æ–°å¢ï¼šä¿å­˜æ ¡å‡†æ•°æ®
                    calibrationData = {
                        calibrationPoints: CalibrationPoints,
                        accuracy: precision_measurement,
                        completedPoints: PointCalibrate,
                        calibrationTime: new Date().toISOString()
                    };
                    
                    swal({
                        title: "Your accuracy measure is " + precision_measurement + "%",
                        allowOutsideClick: false,
                        buttons: {
                            cancel: "Recalibrate",
                            confirm: true,
                        }
                    }).then(isConfirm => {
                        if (isConfirm){
                            ClearCanvas();
                            updateStatus('æ ¡å‡†å®Œæˆ - æ­£åœ¨è¿½è¸ª', 'ready');
                        } else {
                            document.getElementById("Accuracy").innerHTML = "ç­‰å¾…æ ¡å‡†...";
                            webgazer.clearData();
                            ClearCalibration();
                            ClearCanvas();
                            ShowCalibrationPoint();
                        }
                    });
                });
            });
        }

        // ===========================================
        // ä¿æŒåŸæœ‰çš„æ‰€æœ‰å…¶ä»–å‡½æ•°ä¸å˜
        // ===========================================
        
        // ç²¾åº¦è®¡ç®—å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰
        function store_points_variable() {
            isStoring = true;
            storedPoints = {x: [], y: []};
            debug('å¼€å§‹å­˜å‚¨é¢„æµ‹ç‚¹ç”¨äºç²¾åº¦è®¡ç®—');
        }

        function stop_storing_points_variable() {
            isStoring = false;
            debug(`åœæ­¢å­˜å‚¨é¢„æµ‹ç‚¹ï¼Œå…±æ”¶é›†åˆ° ${storedPoints.x.length} ä¸ªç‚¹`);
        }

        function getStoredPoints() {
            return [storedPoints.x, storedPoints.y];
        }

        function calculatePrecision(past50Array) {
            var windowHeight = window.innerHeight;
            var windowWidth = window.innerWidth;
            var x50 = past50Array[0];
            var y50 = past50Array[1];
            var staringPointX = windowWidth / 2;
            var staringPointY = windowHeight / 2;

            debug(`è®¡ç®—ç²¾åº¦: çª—å£å°ºå¯¸ ${windowWidth}x${windowHeight}, å‡è§†ç‚¹ (${staringPointX}, ${staringPointY}), é¢„æµ‹ç‚¹æ•° ${x50.length}`);

            var precisionPercentages = new Array(Math.min(50, x50.length));
            calculatePrecisionPercentages(precisionPercentages, windowHeight, x50, y50, staringPointX, staringPointY);
            var precision = calculateAverage(precisionPercentages);

            debug(`ç²¾åº¦è®¡ç®—å®Œæˆ: ${precision.toFixed(2)}%`);
            return Math.round(precision);
        }

        function calculatePrecisionPercentages(precisionPercentages, windowHeight, x50, y50, staringPointX, staringPointY) {
            var pointCount = Math.min(50, x50.length);
            for (var x = 0; x < pointCount; x++) {
                var xDiff = staringPointX - x50[x];
                var yDiff = staringPointY - y50[x];
                var distance = Math.sqrt((xDiff * xDiff) + (yDiff * yDiff));
                var halfWindowHeight = windowHeight / 2;
                var precision = 0;
                if (distance <= halfWindowHeight && distance > -1) {
                    precision = 100 - (distance / halfWindowHeight * 100);
                } else if (distance > halfWindowHeight) {
                    precision = 0;
                } else if (distance > -1) {
                    precision = 100;
                }
                precisionPercentages[x] = precision;
            }
        }

        function calculateAverage(precisionPercentages) {
            var precision = 0;
            for (var x = 0; x < precisionPercentages.length; x++) {
                precision += precisionPercentages[x];
            }
            precision = precision / precisionPercentages.length;
            return precision;
        }

        // æ ¡å‡†å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰
        function ClearCanvas(){
            document.querySelectorAll('.Calibration').forEach((i) => {
                i.style.setProperty('display', 'none');
            });
            var canvas = document.getElementById("plotting_canvas");
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        }

        function PopUpInstruction(){
            ClearCanvas();
            swal({
                title:"Calibration",
                text: "Please click on each of the 9 points on the screen. You must click on each point 5 times till it goes yellow. This will calibrate your eye movements.",
                buttons:{
                    cancel: false,
                    confirm: true
                }
            }).then(isConfirm => {
                ShowCalibrationPoint();
            });
        }

        function calPointClick(node) {
            const id = node.id;

            if (!CalibrationPoints[id]){ 
                CalibrationPoints[id]=0;
            }
            CalibrationPoints[id]++;

            if (CalibrationPoints[id]==5){ 
                node.style.setProperty('background-color', 'yellow');
                node.setAttribute('disabled', 'disabled');
                PointCalibrate++;
                debug(`æ ¡å‡†ç‚¹ ${id} å®Œæˆï¼Œå·²æ ¡å‡†ç‚¹æ•°: ${PointCalibrate}`);
            }else if (CalibrationPoints[id]<5){
                var opacity = 0.2*CalibrationPoints[id]+0.2;
                node.style.setProperty('opacity', opacity);
                debug(`æ ¡å‡†ç‚¹ ${id} ç‚¹å‡»æ¬¡æ•°: ${CalibrationPoints[id]}/5`);
            }

            if (PointCalibrate == 8){
                document.getElementById('Pt5').style.removeProperty('display');
                debug('æ˜¾ç¤ºä¸­é—´æ ¡å‡†ç‚¹ Pt5');
            }

            if (PointCalibrate >= 9){ 
                document.querySelectorAll('.Calibration').forEach((i) => {
                    i.style.setProperty('display', 'none');
                });
                document.getElementById('Pt5').style.removeProperty('display');
                var canvas = document.getElementById("plotting_canvas");
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                calcAccuracy();
            }
        }

        function ShowCalibrationPoint() {
            document.querySelectorAll('.Calibration').forEach((i) => {
                i.style.removeProperty('display');
            });
            document.getElementById('Pt5').style.setProperty('display', 'none');
        }

        function ClearCalibration(){
            if (typeof webgazer !== 'undefined' && webgazer.clearData) {
                webgazer.clearData();
            }

            document.querySelectorAll('.Calibration').forEach((i) => {
                i.style.setProperty('background-color', 'red');
                i.style.setProperty('opacity', '0.2');
                i.removeAttribute('disabled');
            });

            CalibrationPoints = {};
            PointCalibrate = 0;
        }

        function sleep (time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        function Restart(){
            document.getElementById("Accuracy").innerHTML = "ç­‰å¾…æ ¡å‡†...";
            webgazer.clearData();
            ClearCalibration();
            PopUpInstruction();
        }

        // å…¶ä»–åŸæœ‰å‡½æ•°ä¿æŒä¸å˜...
        async function checkLibrariesLoaded() {
            updateStatus('æ£€æŸ¥åº“æ–‡ä»¶...', 'loading');
            updateLoadingProgress(25);
            
            if (typeof h337 === 'undefined') {
                debug('Heatmapåº“æœªåŠ è½½ï¼Œå°è¯•å†æ¬¡åŠ è½½...');
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                } catch (error) {
                    updateStatus('Heatmapåº“åŠ è½½å¤±è´¥', 'error');
                    document.getElementById('libraryStatus').textContent = 'Heatmapç¼ºå¤±';
                    debug(`HeatmapåŠ è½½é”™è¯¯: ${error.message}`);
                    return false;
                }
            }
            
            updateLoadingProgress(50);
            
            if (typeof webgazer === 'undefined') {
                debug('WebGazeråº“æœªåŠ è½½ï¼Œå°è¯•å†æ¬¡åŠ è½½...');
                try {
                    const success = await loadWebGazerScript();
                    if (!success) {
                        throw new Error('æ‰€æœ‰WebGazeræºéƒ½åŠ è½½å¤±è´¥');
                    }
                } catch (error) {
                    updateStatus('WebGazeråº“åŠ è½½å¤±è´¥ - è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                    document.getElementById('libraryStatus').textContent = 'WebGazerç¼ºå¤±';
                    debug(`WebGazeråŠ è½½é”™è¯¯: ${error.message}`);
                    
                    setTimeout(() => {
                        alert('WebGazeråº“åŠ è½½å¤±è´¥!\n\nå»ºè®®æ–¹æ¡ˆ:\n1. è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. è¯·è®¿é—® https://webgazer.cs.brown.edu/ ä¸‹è½½webgazer.jsæ–‡ä»¶\n3. å°†ä¸‹è½½çš„æ–‡ä»¶æ”¾åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­\n4. åˆ·æ–°é¡µé¢é‡è¯•');
                    }, 500);
                    return false;
                }
            }
            
            if (typeof webgazer === 'undefined' || typeof h337 === 'undefined') {
                updateStatus('åº“åŠ è½½å¼‚å¸¸', 'error');
                document.getElementById('libraryStatus').textContent = 'åŠ è½½å¤±è´¥';
                return false;
            }
            
            updateLoadingProgress(100);
            document.getElementById('libraryStatus').textContent = 'å·²åŠ è½½';
            librariesLoaded = true;
            
            setTimeout(() => {
                document.getElementById('loadingBar').style.display = 'none';
            }, 500);
            
            return true;
        }

        function setupHeatmap() {
            debug('åˆå§‹åŒ–çƒ­åŠ›å›¾...');
            
            try {
                heatmapInstance = h337.create({
                    container: document.getElementById('heatmapContainer'),
                    maxOpacity: 0.8,
                    minOpacity: 0.1,
                    blur: 0.85,
                    gradient: {
                        0.0: 'rgba(0, 0, 255, 0)',
                        0.2: 'rgba(0, 0, 255, 0.5)',
                        0.4: 'rgba(0, 255, 255, 0.7)',
                        0.6: 'rgba(0, 255, 0, 0.8)',
                        0.8: 'rgba(255, 255, 0, 0.9)',
                        1.0: 'rgba(255, 0, 0, 1.0)'
                    }
                });
                
                debug('çƒ­åŠ›å›¾åˆå§‹åŒ–å®Œæˆ');
                return true;
            } catch (error) {
                debug(`çƒ­åŠ›å›¾åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) {
                alert('åº“æ–‡ä»¶è¿˜æœªåŠ è½½å®Œæˆï¼Œè¯·ç­‰å¾…åŠ è½½å®Œæˆåå†è¯•ï¼');
                return;
            }
            
            initializationAttempts++;
            debug(`å¼€å§‹ç¬¬ ${initializationAttempts} æ¬¡åˆå§‹åŒ–å°è¯•`);
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').textContent = 'ğŸ”„ åˆå§‹åŒ–ä¸­...';
            
            updateStatus('åˆå§‹åŒ– WebGazer...', 'initializing');
            document.getElementById('webgazerStatus').textContent = 'åˆå§‹åŒ–ä¸­';

            try {
                await webgazer.setRegression('ridge')
                    .setGazeListener(gazeDataCallback)
                    .saveDataAcrossSessions(true)
                    .begin();
                
                webgazer.showVideoPreview(true)
                        .showPredictionPoints(true)
                        .applyKalmanFilter(true);
                
                debug('WebGazeråˆå§‹åŒ–å®Œæˆï¼Œè®¾ç½®ç”»å¸ƒ...');
                
                var canvas = document.getElementById("plotting_canvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                canvas.style.position = 'fixed';
                
                setupCalibrationListeners();
                
                webgazerReady = true;
                isTracking = true;
                
                updateStatus('WebGazerå°±ç»ª - è¯·è¿›è¡Œæ ¡å‡†', 'ready');
                document.getElementById('webgazerStatus').textContent = 'å°±ç»ª';
                document.getElementById('calibrateBtn').disabled = false;
                document.getElementById('startBtn').textContent = 'âœ… å·²å¯åŠ¨';
                
                debug('WebGazerå¯åŠ¨æˆåŠŸï¼');
                
                setTimeout(() => {
                    if (PointCalibrate === 0) {
                        alert('WebGazerå·²æˆåŠŸå¯åŠ¨ï¼\n\nä¸ºäº†è·å¾—å‡†ç¡®çš„çœ¼åŠ¨è¿½è¸ªï¼Œè¯·ç‚¹å‡»"å¼€å§‹æ ¡å‡†"æŒ‰é’®è¿›è¡Œ9ç‚¹æ ¡å‡†ã€‚\n\næ–°åŠŸèƒ½ï¼šç°åœ¨æ”¯æŒå°†æ•°æ®ä¸Šä¼ åˆ°äº‘ç«¯ï¼');
                    }
                }, 2000);
                
            } catch (error) {
                debug(`WebGazerå¯åŠ¨å¤±è´¥: ${error.message}`);
                updateStatus('å¯åŠ¨å¤±è´¥ - ç‚¹å‡»é‡è¯•', 'error');
                document.getElementById('webgazerStatus').textContent = 'å¯åŠ¨å¤±è´¥';
                resetStartButton();
            }
        }
        
        function setupCalibrationListeners() {
            document.querySelectorAll('.Calibration').forEach((i) => {
                i.addEventListener('click', () => {
                    calPointClick(i);
                });
            });
            debug('æ ¡å‡†ç‚¹å‡»ç›‘å¬å™¨å·²è®¾ç½®');
        }
        
        function resetStartButton() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'ğŸ”„ é‡è¯•å¯åŠ¨';
        }

        function updateStats() {
            document.getElementById('totalGazes').textContent = gazeCount;
            
            let avgDuration = gazeCount > 0 ? Math.round(totalDuration / gazeCount) : 0;
            document.getElementById('avgDuration').textContent = avgDuration + 'ms';

            let elapsedSeconds = (Date.now() - startTime) / 1000;
            let frequency = elapsedSeconds > 0 ? (gazeCount / elapsedSeconds).toFixed(2) : 0;
            document.getElementById('gazeFrequency').textContent = frequency + ' æ¬¡/ç§’';
            
            document.getElementById('runningTime').textContent = Math.round(elapsedSeconds) + 'ç§’';
        }

        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            debug(`çŠ¶æ€æ›´æ–°: ${message}`);
        }

        window.addEventListener('DOMContentLoaded', async function() {
            debug('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥åº“æ–‡ä»¶...');
            
            try {
                const loaded = await checkLibrariesLoaded();
                if (!loaded) {
                    debug('åº“åŠ è½½å¤±è´¥ï¼Œæ— æ³•ç»§ç»­åˆå§‹åŒ–');
                    return;
                }
                
                debug('åº“æ–‡ä»¶åŠ è½½æˆåŠŸï¼Œåˆå§‹åŒ–çƒ­åŠ›å›¾...');
                
                if (!setupHeatmap()) {
                    updateStatus('çƒ­åŠ›å›¾åˆå§‹åŒ–å¤±è´¥', 'error');
                    return;
                }
                
                updateStatus('ç‚¹å‡»å¯åŠ¨æŒ‰é’®å¼€å§‹', 'ready');
                debug('ç³»ç»Ÿå‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ç”¨æˆ·å¯åŠ¨');
                
                document.getElementById('startBtn').disabled = false;
            } catch (error) {
                debug(`åˆå§‹åŒ–è¿‡ç¨‹å‡ºé”™: ${error.message}`);
                updateStatus('åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        });

        function debug(message) {
            if (debugMode) {
                console.log(message);
                const debugDiv = document.getElementById('debugInfo');
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML = `[${timestamp}] ${message}<br>` + debugDiv.innerHTML;
                
                const lines = debugDiv.innerHTML.split('<br>');
                if (lines.length > 15) {
                    debugDiv.innerHTML = lines.slice(0, 15).join('<br>');
                }
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debugPanel').style.display = debugMode ? 'block' : 'none';
            debug('è°ƒè¯•æ¨¡å¼åˆ‡æ¢: ' + (debugMode ? 'å¼€å¯' : 'å…³é—­'));
        }

        function updateLoadingProgress(percent) {
            const progressBar = document.getElementById('loadingBar');
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
        }

        function clearHeatmap() {
            if (heatmapInstance) {
                heatmapInstance.setData({data: [], max: 1000});
                gazeCount = 0;
                totalDuration = 0;
                startTime = Date.now();
                lastGazeTime = 0;
                gazeDataArray = []; // æ¸…ç©ºæ”¶é›†çš„æ•°æ®
                updateStats();
                debug('çƒ­åŠ›å›¾å·²æ¸…é™¤ï¼Œç»Ÿè®¡æ•°æ®å·²é‡ç½®');
            }
        }

        function exportData() {
            const stats = {
                totalGazePoints: gazeCount,
                rawGazeCount: rawGazeCount,
                averageDuration: gazeCount > 0 ? Math.round(totalDuration / gazeCount) : 0,
                gazeFrequency: ((Date.now() - startTime) / 1000 > 0) ? 
                    (gazeCount / ((Date.now() - startTime) / 1000)).toFixed(2) : 0,
                runningTime: Math.round((Date.now() - startTime) / 1000),
                calibrationPoints: PointCalibrate,
                webgazerReady: webgazerReady,
                initializationAttempts: initializationAttempts,
                librariesLoaded: librariesLoaded,
                accuracyMeasurement: document.getElementById("Accuracy").innerHTML,
                storedPointsCount: storedPoints.x.length,
                sessionId: sessionId,
                gazeDataArray: gazeDataArray,
                calibrationData: calibrationData,
                cloudFeatureEnabled: true,
                timestamp: new Date().toLocaleString('zh-CN')
            };
            
            const dataStr = JSON.stringify(stats, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `eye-tracking-data-cloud-${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            debug(`æ•°æ®å·²å¯¼å‡º: ${JSON.stringify(stats)}`);
            alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼åŒ…å«äº‘ç«¯åŠŸèƒ½çš„å®Œæ•´æ•°æ®');
        }

        function stopTracking() {
            isTracking = false;
            webgazerReady = false;
            isStoring = false;
            
            try {
                if (typeof webgazer !== 'undefined' && webgazer.isReady && webgazer.isReady()) {
                    webgazer.end();
                    debug('WebGazerå·²åœæ­¢');
                }
            } catch (error) {
                debug(`åœæ­¢WebGazeræ—¶å‡ºé”™: ${error.message}`);
            }
            
            updateStatus('è¿½è¸ªå·²åœæ­¢', 'error');
            document.getElementById('webgazerStatus').textContent = 'å·²åœæ­¢';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'ğŸš€ å¯åŠ¨çœ¼åŠ¨è¿½è¸ª';
            document.getElementById('calibrateBtn').disabled = true;
            
            ClearCalibration();
            ClearCanvas();
            
            debug('çœ¼åŠ¨è¿½è¸ªå·²åœæ­¢ï¼Œç•Œé¢å·²é‡ç½®');
        }

        window.onbeforeunload = function() {
            if (typeof webgazer !== 'undefined') {
                webgazer.end();
                debug('é¡µé¢å¸è½½ï¼ŒWebGazerèµ„æºå·²æ¸…ç†');
            }
        }

        setInterval(updateStats, 1000);

        window.addEventListener('error', function(event) {
            debug(`å…¨å±€é”™è¯¯: ${event.error?.message || event.message}`);
            console.error('é¡µé¢é”™è¯¯:', event);
        });

        window.addEventListener('unhandledrejection', function(event) {
            debug(`æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`);
            console.error('Promiseé”™è¯¯:', event.reason);
        });
    </script>
</body>
</html>
