<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁúºÂä®ËøΩË∏™Êï∞ÊçÆÊî∂ÈõÜÁ≥ªÁªü - ‰øÆÂ§çÁâà</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase ÈÖçÁΩÆ - ËØ∑ÊõøÊç¢‰∏∫ÊÇ®ÁöÑÈÖçÁΩÆ
        const firebaseConfig = {
            apiKey: "AIzaSyB6O5l6uZa-6sywCZTGRJx2CKPuq3KeBF0",
            authDomain: "index-9f58d.firebaseapp.com",
            projectId: "index-9f58d",
            storageBucket: "index-9f58d.firebasestorage.app",
            messagingSenderId: "718279245978",
            appId: "1:718279245978:web:93a9a07473ad8d3e6a5f23"
        };
        
        // ÂàùÂßãÂåñ Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ÁîüÊàêÂîØ‰∏Ä‰ºöËØùID
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('‰ºöËØùID:', sessionId);

        // Âä®ÊÄÅÂä†ËΩΩWebGazer
        async function loadWebGazerScript() {
            const sources = [
                './webgazer.js',  
                './lib/webgazer.js', 
                'https://webgazer.cs.brown.edu/webgazer.js',
                'https://unpkg.com/webgazer@2.0.2/dist/webgazer.js'
            ];

            for (const source of sources) {
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = source;
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`Êó†Ê≥ï‰ªé ${source} Âä†ËΩΩWebGazer`));
                        document.head.appendChild(script);
                    });
                    console.log(`WebGazer‰ªé ${source} Âä†ËΩΩÊàêÂäü`);
                    return true;
                } catch (error) {
                    console.error(`Â∞ùËØïÂä†ËΩΩÂ§±Ë¥•: ${error.message}`);
                }
            }
            return false;
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #heatmapContainer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: -1000;
            opacity: 0;
            display: none;
        }
        
        #plotting_canvas {
            position: fixed;
            top: 0;
            left: 0;
            cursor: crosshair;
            z-index: 900;
            pointer-events: none;
        }
        
        #content { 
            position: relative; 
            z-index: 1; 
            padding: 50px; 
            max-width: 800px;
            margin: 0 auto;
            background: white;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #statsPanel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 2000;
            min-width: 300px;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .stat-value {
            font-weight: bold;
            color: #4CAF50;
        }
        
        #debugPanel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            z-index: 2000;
            max-width: 350px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-area {
            height: 150px;
            margin: 30px 0;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-area:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .area-blue { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; }
        .area-green { background: linear-gradient(135deg, #00b894, #00a085); color: white; }
        .area-orange { background: linear-gradient(135deg, #fdcb6e, #e17055); color: white; }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover { background: #45a049; }
        .btn.danger { background: #f44336; }
        .btn.danger:hover { background: #da190b; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn.test { background: #2196F3; }
        .btn.test:hover { background: #1976D2; }
        
        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 2000;
        }
        
        .status.ready { background: #4CAF50; color: white; }
        .status.calibrating { background: #ff9800; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.initializing { background: #2196F3; color: white; }
        .status.loading { background: #9C27B0; color: white; }
        
        .loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            z-index: 3000;
            transition: width 0.3s ease;
        }
        
        #webgazerVideoContainer {
            position: fixed !important;
            top: 10px !important;
            right: 10px !important;
            z-index: 9999 !important;
            width: 240px !important;
            height: 180px !important;
        }
        
        #webgazerVideoFeed {
            width: 100% !important;
            height: 100% !important;
            border-radius: 8px !important;
            border: 2px solid #4CAF50 !important;
        }
        
        .Calibration {
            width: 20px;
            height: 20px;
            -webkit-border-radius: 25px;
            -moz-border-radius: 25px;
            border-radius: 25px;
            background-color: red;
            opacity: 0.2;
            border-color: black;
            border-style: solid;
            position: fixed;
            z-index: 99999;
            cursor: pointer;
        }
        
        #Pt1 { top: 10%; left: 10%; }
        #Pt2 { top: 10%; left: 50%; margin-left: -10px; }
        #Pt3 { top: 10%; right: 10%; }
        #Pt4 { top: 50%; margin-top: -10px; left: 10%; }
        #Pt5 { top: 50%; margin-top: -10px; left: 50%; margin-left: -10px; }
        #Pt6 { top: 50%; margin-top: -10px; right: 10%; }
        #Pt7 { bottom: 10%; left: 10%; }
        #Pt8 { bottom: 10%; left: 50%; margin-left: -10px; }
        #Pt9 { bottom: 10%; right: 10%; }
        
        #Accuracy {
            background-color: #222;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }

        .collection-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .collection-status.connected { background: #4CAF50; color: white; }
        .collection-status.disconnected { background: #f44336; color: white; }
        .collection-status.uploading { background: #ff9800; color: white; }

        .firebase-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="loadingBar" class="loading-bar"></div>
    <div id="status" class="status loading">Ê≠£Âú®Âä†ËΩΩÂ∫ìÊñá‰ª∂...</div>
    <canvas id="plotting_canvas" width="500" height="500"></canvas>

    <div id="statsPanel">
        <h3 style="margin-top: 0; color: #4CAF50;">üìä ÁúºÂä®Êï∞ÊçÆÁªüËÆ°</h3>
        <div class="stat-item">
            <span>‰ºöËØùID:</span>
            <span id="sessionIdDisplay" class="stat-value" style="font-size: 10px;"></span>
        </div>
        <div class="stat-item">
            <span>Ê≥®ËßÜÁÇπÊÄªÊï∞:</span>
            <span id="totalGazes" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>ÁúºË∑≥Ê¨°Êï∞:</span>
            <span id="saccadeCount" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>Êï∞ÊçÆÂø´ÁÖßÊï∞:</span>
            <span id="snapshotCount" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span>ËøêË°åÊó∂Èó¥:</span>
            <span id="runningTime" class="stat-value">0Áßí</span>
        </div>
        <div id="Accuracy">Á≠âÂæÖÊ†°ÂáÜ...</div>
        <div class="stat-item">
            <span>Á≥ªÁªüÁä∂ÊÄÅ:</span>
            <span id="systemStatus" class="stat-value">Âä†ËΩΩ‰∏≠</span>
        </div>
        <div class="collection-status disconnected" id="collectionStatus">
            üìà Êï∞ÊçÆÊî∂ÈõÜ: Êú™ÂºÄÂßã
        </div>
        <div class="firebase-status disconnected" id="firebaseStatus">
            üî• Firebase: Êú™ËøûÊé•
        </div>
        
        <!-- Ê∑ªÂä†ÊµãËØïÊåâÈíÆ -->
        <button class="btn test" onclick="testFirebaseConnection()" style="width: 100%; margin-top: 10px;">
            üß™ ÊµãËØïFirebaseËøûÊé•
        </button>
        <button class="btn test" onclick="forceSaveData()" style="width: 100%; margin-top: 5px;">
            üíæ Âº∫Âà∂‰øùÂ≠òÊµãËØïÊï∞ÊçÆ
        </button>
    </div>

    <div id="debugPanel">
        <div id="debugInfo">Ë∞ÉËØï‰ø°ÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫...</div>
    </div>

    <div id="heatmapContainer"></div>

    <div class="calibrationDiv">
        <input type="button" class="Calibration" id="Pt1" style="display: none;">
        <input type="button" class="Calibration" id="Pt2" style="display: none;">
        <input type="button" class="Calibration" id="Pt3" style="display: none;">
        <input type="button" class="Calibration" id="Pt4" style="display: none;">
        <input type="button" class="Calibration" id="Pt5" style="display: none;">
        <input type="button" class="Calibration" id="Pt6" style="display: none;">
        <input type="button" class="Calibration" id="Pt7" style="display: none;">
        <input type="button" class="Calibration" id="Pt8" style="display: none;">
        <input type="button" class="Calibration" id="Pt9" style="display: none;">
    </div>

    <div id="content">
        <h1 style="text-align: center; color: #333;">üëÅÔ∏è ÁúºÂä®ËøΩË∏™Êï∞ÊçÆÊî∂ÈõÜÁ≥ªÁªü - ‰øÆÂ§çÁâà</h1>
        
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startEyeTracking()">üöÄ ÂêØÂä®ÁúºÂä®ËøΩË∏™</button>
            <button class="btn" id="calibrateBtn" onclick="PopUpInstruction()" disabled>üéØ ÂºÄÂßãÊ†°ÂáÜ</button>
            <button class="btn" onclick="Restart()">üîÑ ÈáçÊñ∞Ê†°ÂáÜ</button>
            <button class="btn" onclick="exportData()">üìä ÂØºÂá∫Êï∞ÊçÆ</button>
            <button class="btn" onclick="toggleDebug()">üêõ ÂàáÊç¢Ë∞ÉËØï</button>
            <button class="btn danger" onclick="stopTracking()">‚èπÔ∏è ÂÅúÊ≠¢ËøΩË∏™</button>
        </div>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <h4 style="margin-top: 0; color: #1565c0;">üîß ËØäÊñ≠‰ø°ÊÅØÔºö</h4>
            <p><strong>ÂΩìÂâçÊó∂Èó¥Ôºö</strong> 2025-08-09 14:07:27 (UTC)</p>
            <p><strong>Áî®Êà∑Ôºö</strong> jingtianwei2002</p>
            <p><strong>‰øÆÂ§çÁâàÊú¨ÁâπÁÇπÔºö</strong></p>
            <ul>
                <li>‚úÖ Â¢ûÂº∫ÁöÑÈîôËØØÊó•ÂøóËÆ∞ÂΩï</li>
                <li>‚úÖ ÂÆûÊó∂FirebaseËøûÊé•Áä∂ÊÄÅÊòæÁ§∫</li>
                <li>‚úÖ ÊâãÂä®ÊµãËØïÊåâÈíÆ</li>
                <li>‚úÖ Âº∫Âà∂Êï∞ÊçÆ‰øùÂ≠òÂäüËÉΩ</li>
                <li>‚úÖ ËØ¶ÁªÜÁöÑË∞ÉËØï‰ø°ÊÅØ</li>
            </ul>
        </div>
        
        <p style="text-align: center; font-size: 18px; color: #666;">
            üëÄ ËØ∑Ëá™ÁÑ∂Âú∞ÊµèËßà‰∏ãÈù¢ÁöÑÂÜÖÂÆπÔºåÁ≥ªÁªü‰ºöËá™Âä®Êî∂ÈõÜÊÇ®ÁöÑÁúºÂä®Êï∞ÊçÆ<br>
            üìä Êï∞ÊçÆÊØèÁßíËá™Âä®‰øùÂ≠òÂà∞‰∫ëÁ´ØÊï∞ÊçÆÂ∫ìÔºàÂè≥‰æßÂèØÊü•ÁúãÁä∂ÊÄÅÔºâ
        </p>
        
        <div class="test-area area-blue">
            <h2>üåä Âå∫Âüü A - Êµ∑Ê¥ãËìù</h2>
            <p>ËøôÊòØÁ¨¨‰∏Ä‰∏™ÊµãËØïÂå∫Âüü„ÄÇËØ∑Â∞ùËØïÊ≥®ËßÜËøôÈáåÂá†ÁßíÈíüÔºåÁ≥ªÁªü‰ºöËÆ∞ÂΩïÊÇ®ÁöÑÊ≥®ËßÜÁÇπ„ÄÅÊ≥®ËßÜÊó∂Èó¥ÂíåÁúºÂä®Ê®°Âºè„ÄÇÂè≥‰æßÈù¢Êùø‰ºöÊòæÁ§∫ÂÆûÊó∂Áä∂ÊÄÅ„ÄÇ</p>
        </div>
        
        <div class="test-area area-green">
            <h2>üåø Âå∫Âüü B - Ê£ÆÊûóÁªø</h2>
            <p>ËøôÊòØÁ¨¨‰∫å‰∏™ÊµãËØïÂå∫Âüü„ÄÇÊÇ®ÂèØ‰ª•Âú®‰∏çÂêåÂå∫Âüü‰πãÈó¥ÁßªÂä®ËßÜÁ∫øÔºåÁ≥ªÁªü‰ºöÂÆûÊó∂ËÆ∞ÂΩïÊÇ®ÁöÑÁúºË∑≥„ÄÅÊ≥®ËßÜÊó∂ÈïøÂíåÁÉ≠ÂäõÂõæÊï∞ÊçÆ„ÄÇ</p>
        </div>
        
        <div class="test-area area-orange">
            <h2>üî• Âå∫Âüü C - Â§ïÈò≥Ê©ô</h2>
            <p>ËøôÊòØÁ¨¨‰∏â‰∏™ÊµãËØïÂå∫Âüü„ÄÇÁ≥ªÁªü‰ºöÂàÜÊûêÊÇ®ÁöÑÁúºÂä®ËΩ®ËøπÔºåÁîüÊàêËØ¶ÁªÜÁöÑÊ≥®ËßÜÁÇπÊï∞ÊçÆÂíåÁÉ≠ÂäõÂõæÔºåÊØèÁßíËá™Âä®‰øùÂ≠ò‰∏ÄÊ¨°Âà∞Firebase„ÄÇ</p>
        </div>
    </div>

    <script>
        // ===========================================
        // ÂÖ®Â±ÄÂèòÈáèÂÆö‰πâ
        // ===========================================
        let heatmapInstance = null;
        let gazeCount = 0;
        let saccadeCount = 0;
        let snapshotCount = 0;
        let totalDuration = 0;
        let startTime = Date.now();
        let isTracking = false;
        let webgazerReady = false;
        let debugMode = true;
        let rawGazeCount = 0;
        let initializationAttempts = 0;
        let librariesLoaded = false;
        let lastGazeTime = 0;
        let firebaseConnected = false;
        
        // Ê†°ÂáÜÁõ∏ÂÖ≥ÂèòÈáè
        var PointCalibrate = 0;
        var CalibrationPoints = {};

        // Á≤æÂ∫¶ËÆ°ÁÆóÁõ∏ÂÖ≥ÂèòÈáè
        var isStoring = false;
        var storedPoints = {x: [], y: []};

        // Êï∞ÊçÆÊî∂ÈõÜÂèòÈáè
        let gazeData = [];
        let saccadeData = [];
        let fixationData = [];
        let sessionStartTime = new Date().toISOString();
        let lastGazePoint = null;
        let currentFixation = null;
        let autoSaveInterval = null;

        // ÁúºË∑≥Ê£ÄÊµãÂèÇÊï∞
        const SACCADE_THRESHOLD = 100;
        const FIXATION_MIN_DURATION = 100;

        // ÊòæÁ§∫‰ºöËØùID
        document.getElementById('sessionIdDisplay').textContent = sessionId.substring(0, 15) + '...';

        // ===========================================
        // Firebase ËøûÊé•ÊµãËØïÂíåÁä∂ÊÄÅÁÆ°ÁêÜ
        // ===========================================
        
        /**
         * ÊµãËØïFirebaseËøûÊé•
         */
        async function testFirebaseConnection() {
            debug('ÂºÄÂßãÊµãËØïFirebaseËøûÊé•...');
            updateFirebaseStatus('ÊµãËØï‰∏≠...', 'uploading');
            
            try {
                // ÊµãËØïÂÜôÂÖ•
                const testDoc = await db.collection("connection_test").add({
                    test: true,
                    timestamp: new Date().toISOString(),
                    user: 'jingtianwei2002',
                    sessionId: sessionId
                });
                
                debug(`FirebaseËøûÊé•ÊµãËØïÊàêÂäüÔºÅÊñáÊ°£ID: ${testDoc.id}`);
                updateFirebaseStatus('ËøûÊé•Ê≠£Â∏∏', 'connected');
                firebaseConnected = true;
                
                // ÊµãËØïËØªÂèñ
                const readTest = await db.collection("connection_test").doc(testDoc.id).get();
                if (readTest.exists) {
                    debug('FirebaseËØªÂèñÊµãËØï‰πüÊàêÂäüÔºÅ');
                    alert('üéâ FirebaseËøûÊé•ÊµãËØïÊàêÂäüÔºÅ\n\n‚úÖ ÂÜôÂÖ•ÊµãËØïÈÄöËøá\n‚úÖ ËØªÂèñÊµãËØïÈÄöËøá\n\nÁé∞Âú®ÂèØ‰ª•Ê≠£Â∏∏Êî∂ÈõÜÊï∞ÊçÆ‰∫ÜÔºÅ');
                } else {
                    throw new Error('ËØªÂèñÊµãËØïÂ§±Ë¥•');
                }
                
                return true;
            } catch (error) {
                debug(`FirebaseËøûÊé•ÊµãËØïÂ§±Ë¥•: ${error.message}`);
                updateFirebaseStatus('ËøûÊé•Â§±Ë¥•', 'disconnected');
                firebaseConnected = false;
                
                let errorMsg = '‚ùå FirebaseËøûÊé•ÊµãËØïÂ§±Ë¥•ÔºÅ\n\n';
                if (error.code === 'permission-denied') {
                    errorMsg += 'üîí ÊùÉÈôêË¢´ÊãíÁªù - ËØ∑Ê£ÄÊü•FirestoreÂÆâÂÖ®ËßÑÂàô\n\n';
                    errorMsg += 'Âª∫ËÆÆËÆæÁΩÆËßÑÂàôÔºö\n';
                    errorMsg += 'allow read, write: if request.time < timestamp.date(2026, 12, 31);';
                } else if (error.code === 'unavailable') {
                    errorMsg += 'üåê ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò - ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                } else {
                    errorMsg += `ËØ¶ÁªÜÈîôËØØ: ${error.message}`;
                }
                
                alert(errorMsg);
                console.error('FirebaseÊµãËØïÂÆåÊï¥ÈîôËØØ:', error);
                return false;
            }
        }

        /**
         * Êõ¥Êñ∞FirebaseÁä∂ÊÄÅÊòæÁ§∫
         */
        function updateFirebaseStatus(message, status) {
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.textContent = `üî• Firebase: ${message}`;
            statusElement.className = `firebase-status ${status}`;
        }

        /**
         * Âº∫Âà∂‰øùÂ≠òÊµãËØïÊï∞ÊçÆ
         */
        async function forceSaveData() {
            if (!firebaseConnected) {
                alert('‚ùå ËØ∑ÂÖàÊµãËØïFirebaseËøûÊé•ÔºÅ');
                return;
            }
            
            debug('Âº∫Âà∂‰øùÂ≠òÊµãËØïÊï∞ÊçÆ...');
            
            try {
                const testData = {
                    sessionId: sessionId,
                    timestamp: new Date().toISOString(),
                    dataType: 'manual_test',
                    snapshot: {
                        gazePoints: gazeData.length > 0 ? gazeData : [
                            { x: 100, y: 100, timestamp: new Date().toISOString(), duration: 50 },
                            { x: 200, y: 150, timestamp: new Date().toISOString(), duration: 75 }
                        ],
                        saccades: saccadeData.length > 0 ? saccadeData : [
                            { fromX: 100, fromY: 100, toX: 200, toY: 150, distance: 125, duration: 25, timestamp: new Date().toISOString() }
                        ],
                        fixations: fixationData.length > 0 ? fixationData : [
                            { x: 150, y: 125, duration: 500, startTime: new Date().toISOString(), endTime: new Date().toISOString(), pointCount: 5 }
                        ],
                        heatmapData: {
                            dataPoints: [{ x: 150, y: 125, value: 50 }],
                            maxValue: 100,
                            timestamp: new Date().toISOString()
                        },
                        statistics: {
                            totalGazePoints: gazeCount || 2,
                            totalSaccades: saccadeCount || 1,
                            averageFixationDuration: 500,
                            runningTime: Math.round((Date.now() - startTime) / 1000)
                        }
                    },
                    deviceInfo: {
                        windowWidth: window.innerWidth,
                        windowHeight: window.innerHeight,
                        userAgent: navigator.userAgent,
                        user: 'jingtianwei2002'
                    },
                    testNote: 'ÊâãÂä®‰øùÂ≠òÁöÑÊµãËØïÊï∞ÊçÆ'
                };

                const docRef = await db.collection("eye_tracking_snapshots").add(testData);
                
                snapshotCount++;
                document.getElementById('snapshotCount').textContent = snapshotCount;
                
                debug(`ÊµãËØïÊï∞ÊçÆ‰øùÂ≠òÊàêÂäüÔºÅÊñáÊ°£ID: ${docRef.id}`);
                alert(`‚úÖ ÊµãËØïÊï∞ÊçÆ‰øùÂ≠òÊàêÂäüÔºÅ\n\nüìÑ ÊñáÊ°£ID: ${docRef.id}\nüî¢ Âø´ÁÖßÁºñÂè∑: ${snapshotCount}\n\nËØ∑Âà∞FirebaseÊéßÂà∂Âè∞Êü•ÁúãÊï∞ÊçÆÔºÅ`);
                
            } catch (error) {
                debug(`ÊµãËØïÊï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•: ${error.message}`);
                alert(`‚ùå ÊµãËØïÊï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•ÔºÅ\n\n${error.message}`);
                console.error('‰øùÂ≠òÈîôËØØËØ¶ÊÉÖ:', error);
            }
        }

        // ===========================================
        // ÊîπËøõÁöÑËá™Âä®Êï∞ÊçÆ‰øùÂ≠òÂäüËÉΩ
        // ===========================================
        
        /**
         * ÂêØÂä®Ëá™Âä®‰øùÂ≠ò
         */
        function startAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            autoSaveInterval = setInterval(async () => {
                if (isTracking && firebaseConnected) {
                    await saveDataSnapshot();
                }
            }, 1000);
            
            updateCollectionStatus('ËøõË°å‰∏≠ (ÊØèÁßíËá™Âä®‰øùÂ≠ò)', 'connected');
            debug('Ëá™Âä®‰øùÂ≠òÂ∑≤ÂêØÂä®ÔºåÊØèÁßí‰øùÂ≠ò‰∏ÄÊ¨°Êï∞ÊçÆ');
        }

        /**
         * ÂÅúÊ≠¢Ëá™Âä®‰øùÂ≠ò
         */
        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            updateCollectionStatus('Â∑≤ÂÅúÊ≠¢', 'disconnected');
            debug('Ëá™Âä®‰øùÂ≠òÂ∑≤ÂÅúÊ≠¢');
        }

        /**
         * Êõ¥Êñ∞Êï∞ÊçÆÊî∂ÈõÜÁä∂ÊÄÅ
         */
        function updateCollectionStatus(message, status) {
            const statusElement = document.getElementById('collectionStatus');
            statusElement.textContent = `üìà Êï∞ÊçÆÊî∂ÈõÜ: ${message}`;
            statusElement.className = `collection-status ${status}`;
        }

        /**
         * ÊîπËøõÁöÑÊï∞ÊçÆÂø´ÁÖß‰øùÂ≠ò
         */
        async function saveDataSnapshot() {
            if (!firebaseConnected) {
                debug('FirebaseÊú™ËøûÊé•ÔºåË∑≥ËøáÊï∞ÊçÆ‰øùÂ≠ò');
                return;
            }
            
            try {
                updateCollectionStatus('‰øùÂ≠ò‰∏≠...', 'uploading');
                
                // Âç≥‰ΩøÊ≤°ÊúâÊñ∞Êï∞ÊçÆ‰πü‰øùÂ≠òÁä∂ÊÄÅ‰ø°ÊÅØ
                const snapshotData = {
                    sessionId: sessionId,
                    timestamp: new Date().toISOString(),
                    snapshot: {
                        gazePoints: [...gazeData],
                        saccades: [...saccadeData],
                        fixations: [...fixationData],
                        heatmapData: generateHeatmapSnapshot(),
                        statistics: {
                            totalGazePoints: gazeCount,
                            totalSaccades: saccadeCount,
                            averageFixationDuration: calculateAverageFixationDuration(),
                            runningTime: Math.round((Date.now() - startTime) / 1000),
                            snapshotNumber: snapshotCount + 1
                        }
                    },
                    deviceInfo: {
                        windowWidth: window.innerWidth,
                        windowHeight: window.innerHeight,
                        userAgent: navigator.userAgent,
                        user: 'jingtianwei2002'
                    },
                    calibrationInfo: {
                        calibrationCompleted: PointCalibrate >= 9,
                        accuracy: document.getElementById("Accuracy").textContent
                    }
                };

                const docRef = await db.collection("eye_tracking_snapshots").add(snapshotData);
                
                snapshotCount++;
                document.getElementById('snapshotCount').textContent = snapshotCount;
                
                debug(`Êï∞ÊçÆÂø´ÁÖß #${snapshotCount} Â∑≤‰øùÂ≠ò: ${gazeData.length} Ê≥®ËßÜÁÇπ, ÊñáÊ°£ID: ${docRef.id.substring(0, 8)}...`);
                
                // Ê∏ÖÁ©∫Êú¨Âú∞ÁºìÂ≠ò
                gazeData = [];
                saccadeData = [];
                
                updateCollectionStatus('ËøõË°å‰∏≠ (ÊØèÁßíËá™Âä®‰øùÂ≠ò)', 'connected');
                
            } catch (error) {
                debug(`Êï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•: ${error.message}`);
                updateCollectionStatus('‰øùÂ≠òÂ§±Ë¥•', 'disconnected');
                console.error('‰øùÂ≠òÈîôËØØ:', error);
                
                // Â¶ÇÊûúÊòØÊùÉÈôêÈîôËØØÔºåÊèêÁ§∫Áî®Êà∑
                if (error.code === 'permission-denied') {
                    alert('‚ö†Ô∏è Êï∞ÊçÆ‰øùÂ≠òÊùÉÈôêË¢´ÊãíÁªùÔºÅ\n\nËØ∑Ê£ÄÊü•FirestoreÂÆâÂÖ®ËßÑÂàôÊòØÂê¶Ê≠£Á°ÆËÆæÁΩÆ„ÄÇ');
                }
            }
        }

        /**
         * ÁîüÊàêÁÉ≠ÂäõÂõæÂø´ÁÖßÊï∞ÊçÆ
         */
        function generateHeatmapSnapshot() {
            if (!heatmapInstance || !heatmapInstance._store) {
                return {
                    dataPoints: [],
                    maxValue: 0,
                    timestamp: new Date().toISOString()
                };
            }

            const heatmapData = heatmapInstance._store._data || [];
            
            return {
                dataPoints: heatmapData.map(point => ({
                    x: point.x,
                    y: point.y,
                    value: point.value
                })),
                maxValue: heatmapInstance._store.max || 0,
                timestamp: new Date().toISOString()
            };
        }

        /**
         * ËÆ°ÁÆóÂπ≥ÂùáÊ≥®ËßÜÊó∂Èïø
         */
        function calculateAverageFixationDuration() {
            if (fixationData.length === 0) return 0;
            const totalDuration = fixationData.reduce((sum, fix) => sum + fix.duration, 0);
            return Math.round(totalDuration / fixationData.length);
        }

        // ===========================================
        // ÂÖ∂‰ΩôÂáΩÊï∞‰øùÊåÅ‰∏çÂèòÔºå‰ΩÜÊ∑ªÂä†Êõ¥Â§öË∞ÉËØï‰ø°ÊÅØ
        // ===========================================
        
        function detectSaccade(currentPoint, previousPoint) {
            if (!previousPoint || !currentPoint) return false;
            
            const distance = Math.sqrt(
                Math.pow(currentPoint.x - previousPoint.x, 2) + 
                Math.pow(currentPoint.y - previousPoint.y, 2)
            );
            
            return distance > SACCADE_THRESHOLD;
        }

        function processFixation(gazePoint) {
            const currentTime = Date.now();
            
            if (!currentFixation) {
                currentFixation = {
                    startTime: currentTime,
                    x: gazePoint.x,
                    y: gazePoint.y,
                    points: [gazePoint]
                };
            } else {
                const distance = Math.sqrt(
                    Math.pow(gazePoint.x - currentFixation.x, 2) + 
                    Math.pow(gazePoint.y - currentFixation.y, 2)
                );
                
                if (distance < SACCADE_THRESHOLD) {
                    currentFixation.points.push(gazePoint);
                    const avgX = currentFixation.points.reduce((sum, p) => sum + p.x, 0) / currentFixation.points.length;
                    const avgY = currentFixation.points.reduce((sum, p) => sum + p.y, 0) / currentFixation.points.length;
                    currentFixation.x = avgX;
                    currentFixation.y = avgY;
                } else {
                    const duration = currentTime - currentFixation.startTime;
                    if (duration >= FIXATION_MIN_DURATION) {
                        fixationData.push({
                            x: Math.round(currentFixation.x),
                            y: Math.round(currentFixation.y),
                            duration: duration,
                            startTime: new Date(currentFixation.startTime).toISOString(),
                            endTime: new Date(currentTime).toISOString(),
                            pointCount: currentFixation.points.length
                        });
                    }
                    
                    currentFixation = {
                        startTime: currentTime,
                        x: gazePoint.x,
                        y: gazePoint.y,
                        points: [gazePoint]
                    };
                }
            }
        }

        // Á≤æÂ∫¶ËÆ°ÁÆóÂáΩÊï∞‰øùÊåÅ‰∏çÂèò
        function store_points_variable() {
            isStoring = true;
            storedPoints = {x: [], y: []};
            debug('ÂºÄÂßãÂ≠òÂÇ®È¢ÑÊµãÁÇπÁî®‰∫éÁ≤æÂ∫¶ËÆ°ÁÆó');
        }

        function stop_storing_points_variable() {
            isStoring = false;
            debug(`ÂÅúÊ≠¢Â≠òÂÇ®È¢ÑÊµãÁÇπÔºåÂÖ±Êî∂ÈõÜÂà∞ ${storedPoints.x.length} ‰∏™ÁÇπ`);
        }

        function getStoredPoints() {
            return [storedPoints.x, storedPoints.y];
        }

        function calculatePrecision(past50Array) {
            var windowHeight = window.innerHeight;
            var windowWidth = window.innerWidth;
            var x50 = past50Array[0];
            var y50 = past50Array[1];
            var staringPointX = windowWidth / 2;
            var staringPointY = windowHeight / 2;

            debug(`ËÆ°ÁÆóÁ≤æÂ∫¶: Á™óÂè£Â∞∫ÂØ∏ ${windowWidth}x${windowHeight}, ÂáùËßÜÁÇπ (${staringPointX}, ${staringPointY}), È¢ÑÊµãÁÇπÊï∞ ${x50.length}`);

            var precisionPercentages = new Array(Math.min(50, x50.length));
            calculatePrecisionPercentages(precisionPercentages, windowHeight, x50, y50, staringPointX, staringPointY);
            var precision = calculateAverage(precisionPercentages);

            debug(`Á≤æÂ∫¶ËÆ°ÁÆóÂÆåÊàê: ${precision.toFixed(2)}%`);
            return Math.round(precision);
        }

        function calculatePrecisionPercentages(precisionPercentages, windowHeight, x50, y50, staringPointX, staringPointY) {
            var pointCount = Math.min(50, x50.length);
            for (var x = 0; x < pointCount; x++) {
                var xDiff = staringPointX - x50[x];
                var yDiff = staringPointY - y50[x];
                var distance = Math.sqrt((xDiff * xDiff) + (yDiff * yDiff));
                var halfWindowHeight = windowHeight / 2;
                var precision = 0;
                if (distance <= halfWindowHeight && distance > -1) {
                    precision = 100 - (distance / halfWindowHeight * 100);
                } else if (distance > halfWindowHeight) {
                    precision = 0;
                } else if (distance > -1) {
                    precision = 100;
                }
                precisionPercentages[x] = precision;
            }
        }

        function calculateAverage(precisionPercentages) {
            var precision = 0;
            for (var x = 0; x < precisionPercentages.length; x++) {
                precision += precisionPercentages[x];
            }
            precision = precision / precisionPercentages.length;
            return precision;
        }

        // Ê†°ÂáÜÂáΩÊï∞‰øùÊåÅ‰∏çÂèò
        function ClearCanvas(){
            document.querySelectorAll('.Calibration').forEach((i) => {
                i.style.setProperty('display', 'none');
            });
            var canvas = document.getElementById("plotting_canvas");
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        }

        function PopUpInstruction(){
            ClearCanvas();
            swal({
                title:"Calibration",
                text: "Please click on each of the 9 points on the screen. You must click on each point 5 times till it goes yellow. This will calibrate your eye movements.",
                buttons:{
                    cancel: false,
                    confirm: true
                }
            }).then(isConfirm => {
                ShowCalibrationPoint();
            });
        }

        function calPointClick(node) {
            const id = node.id;
            if (!CalibrationPoints[id]){ 
                CalibrationPoints[id]=0;
            }
            CalibrationPoints[id]++;

            if (CalibrationPoints[id]==5){ 
                node.style.setProperty('background-color', 'yellow');
                node.setAttribute('disabled', 'disabled');
                PointCalibrate++;
                debug(`Ê†°ÂáÜÁÇπ ${id} ÂÆåÊàêÔºåÂ∑≤Ê†°ÂáÜÁÇπÊï∞: ${PointCalibrate}`);
            }else if (CalibrationPoints[id]<5){
                var opacity = 0.2*CalibrationPoints[id]+0.2;
                node.style.setProperty('opacity', opacity);
                debug(`Ê†°ÂáÜÁÇπ ${id} ÁÇπÂáªÊ¨°Êï∞: ${CalibrationPoints[id]}/5`);
            }

            if (PointCalibrate == 8){
                document.getElementById('Pt5').style.removeProperty('display');
                debug('ÊòæÁ§∫‰∏≠Èó¥Ê†°ÂáÜÁÇπ Pt5');
            }

            if (PointCalibrate >= 9){ 
                document.querySelectorAll('.Calibration').forEach((i) => {
                    i.style.setProperty('display', 'none');
                });
                document.getElementById('Pt5').style.removeProperty('display');
                var canvas = document.getElementById("plotting_canvas");
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                calcAccuracy();
            }
        }

        function ShowCalibrationPoint() {
            document.querySelectorAll('.Calibration').forEach((i) => {
                i.style.removeProperty('display');
            });
            document.getElementById('Pt5').style.setProperty('display', 'none');
        }

        function ClearCalibration(){
            if (typeof webgazer !== 'undefined' && webgazer.clearData) {
                webgazer.clearData();
            }
            document.querySelectorAll('.Calibration').forEach((i) => {
                i.style.setProperty('background-color', 'red');
                i.style.setProperty('opacity', '0.2');
                i.removeAttribute('disabled');
            });
            CalibrationPoints = {};
            PointCalibrate = 0;
        }

        function sleep (time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        function Restart(){
            document.getElementById("Accuracy").innerHTML = "Á≠âÂæÖÊ†°ÂáÜ...";
            webgazer.clearData();
            ClearCalibration();
            PopUpInstruction();
        }

        function calcAccuracy() {
            swal({
                title: "Calculating measurement",
                text: "Please don't move your mouse & stare at the middle dot for the next 5 seconds. This will allow us to calculate the accuracy of our predictions.",
                closeOnEsc: false,
                allowOutsideClick: false,
                closeModal: true
            }).then( () => {
                debug('ÂºÄÂßã5ÁßíÁ≤æÂ∫¶ÊµãÈáèÔºåËØ∑ÂáùËßÜÂ±èÂπï‰∏≠ÂøÉ');
                store_points_variable();
                
                sleep(5000).then(() => {
                    stop_storing_points_variable();
                    var past50 = getStoredPoints();
                    
                    if (past50[0].length === 0) {
                        debug('Ë≠¶ÂëäÔºöÊú™Êî∂ÈõÜÂà∞È¢ÑÊµãÁÇπÔºå‰ΩøÁî®ÈªòËÆ§Á≤æÂ∫¶');
                        var precision_measurement = 50;
                    } else {
                        var precision_measurement = calculatePrecision(past50);
                    }
                    
                    var accuracyLabel = "Accuracy | "+precision_measurement+"%";
                    document.getElementById("Accuracy").innerHTML = accuracyLabel;
                    debug(`Á≤æÂ∫¶ÊµãÈáèÂÆåÊàê: ${precision_measurement}%`);
                    
                    swal({
                        title: "Your accuracy measure is " + precision_measurement + "%",
                        allowOutsideClick: false,
                        buttons: {
                            cancel: "Recalibrate",
                            confirm: true,
                        }
                    }).then(isConfirm => {
                        if (isConfirm){
                            ClearCanvas();
                            updateStatus('Ê†°ÂáÜÂÆåÊàê - ÂºÄÂßãÊï∞ÊçÆÊî∂ÈõÜ', 'ready');
                            // Ê†°ÂáÜÂÆåÊàêÂêéÂêØÂä®Ëá™Âä®‰øùÂ≠ò
                            if (firebaseConnected) {
                                startAutoSave();
                            } else {
                                alert('‚ö†Ô∏è FirebaseÊú™ËøûÊé•ÔºåËØ∑ÂÖàÊµãËØïËøûÊé•ÂêéÂÜçÂºÄÂßãÊï∞ÊçÆÊî∂ÈõÜÔºÅ');
                            }
                        } else {
                            document.getElementById("Accuracy").innerHTML = "Á≠âÂæÖÊ†°ÂáÜ...";
                            webgazer.clearData();
                            ClearCalibration();
                            ClearCanvas();
                            ShowCalibrationPoint();
                        }
                    });
                });
            });
        }

        // Â∫ìÂä†ËΩΩÊ£ÄÊü•
        async function checkLibrariesLoaded() {
            updateStatus('Ê£ÄÊü•Â∫ìÊñá‰ª∂...', 'loading');
            updateLoadingProgress(25);
            
            if (typeof h337 === 'undefined') {
                debug('HeatmapÂ∫ìÊú™Âä†ËΩΩÔºåÂ∞ùËØïÂÜçÊ¨°Âä†ËΩΩ...');
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                } catch (error) {
                    updateStatus('HeatmapÂ∫ìÂä†ËΩΩÂ§±Ë¥•', 'error');
                    document.getElementById('systemStatus').textContent = 'HeatmapÁº∫Â§±';
                    debug(`HeatmapÂä†ËΩΩÈîôËØØ: ${error.message}`);
                    return false;
                }
            }
            
            updateLoadingProgress(50);
            
            if (typeof webgazer === 'undefined') {
                debug('WebGazerÂ∫ìÊú™Âä†ËΩΩÔºåÂ∞ùËØïÂÜçÊ¨°Âä†ËΩΩ...');
                try {
                    const success = await loadWebGazerScript();
                    if (!success) {
                        throw new Error('ÊâÄÊúâWebGazerÊ∫êÈÉΩÂä†ËΩΩÂ§±Ë¥•');
                    }
                } catch (error) {
                    updateStatus('WebGazerÂ∫ìÂä†ËΩΩÂ§±Ë¥•', 'error');
                    document.getElementById('systemStatus').textContent = 'WebGazerÁº∫Â§±';
                    debug(`WebGazerÂä†ËΩΩÈîôËØØ: ${error.message}`);
                    return false;
                }
            }
            
            updateLoadingProgress(75);
            
            // ÊµãËØïFirebaseËøûÊé•
            setTimeout(testFirebaseConnection, 1000);
            
            updateLoadingProgress(100);
            document.getElementById('systemStatus').textContent = 'Â∑≤Âä†ËΩΩ';
            librariesLoaded = true;
            
            setTimeout(() => {
                document.getElementById('loadingBar').style.display = 'none';
            }, 500);
            
            return true;
        }

        // ÁÉ≠ÂäõÂõæÂàùÂßãÂåñ
        function setupHeatmap() {
            debug('ÂàùÂßãÂåñÂêéÂè∞ÁÉ≠ÂäõÂõæ...');
            
            try {
                heatmapInstance = h337.create({
                    container: document.getElementById('heatmapContainer'),
                    maxOpacity: 0.8,
                    minOpacity: 0.1,
                    blur: 0.85,
                    gradient: {
                        0.0: 'rgba(0, 0, 255, 0)',
                        0.2: 'rgba(0, 0, 255, 0.5)',
                        0.4: 'rgba(0, 255, 255, 0.7)',
                        0.6: 'rgba(0, 255, 0, 0.8)',
                        0.8: 'rgba(255, 255, 0, 0.9)',
                        1.0: 'rgba(255, 0, 0, 1.0)'
                    }
                });
                
                debug('ÂêéÂè∞ÁÉ≠ÂäõÂõæÂàùÂßãÂåñÂÆåÊàê');
                return true;
            } catch (error) {
                debug(`ÁÉ≠ÂäõÂõæÂàùÂßãÂåñÂ§±Ë¥•: ${error.message}`);
                return false;
            }
        }

        // ÁúºÂä®Êï∞ÊçÆÁõëÂê¨Âô®
        function gazeDataCallback(data, elapsedTime) {
            rawGazeCount++;
            
            if (data == null || !isTracking) {
                return;
            }

            if (isStoring && data.x && data.y) {
                storedPoints.x.push(data.x);
                storedPoints.y.push(data.y);
            }
            
            let currentTime = Date.now();
            
            if (data.x < 0 || data.x > window.innerWidth || 
                data.y < 0 || data.y > window.innerHeight) {
                return;
            }
            
            let timeDiff = currentTime - lastGazeTime;
            if (lastGazeTime > 0 && timeDiff > 16 && timeDiff < 1000) {
                let gazePoint = {
                    x: Math.floor(data.x),
                    y: Math.floor(data.y),
                    timestamp: new Date().toISOString(),
                    duration: timeDiff
                };
                
                // Ê£ÄÊµãÁúºË∑≥
                if (lastGazePoint && detectSaccade(gazePoint, lastGazePoint)) {
                    saccadeData.push({
                        fromX: lastGazePoint.x,
                        fromY: lastGazePoint.y,
                        toX: gazePoint.x,
                        toY: gazePoint.y,
                        distance: Math.sqrt(
                            Math.pow(gazePoint.x - lastGazePoint.x, 2) + 
                            Math.pow(gazePoint.y - lastGazePoint.y, 2)
                        ),
                        duration: timeDiff,
                        timestamp: gazePoint.timestamp
                    });
                    saccadeCount++;
                }
                
                // Â§ÑÁêÜÊ≥®ËßÜ
                processFixation(gazePoint);
                
                // ËÆ∞ÂΩïÊ≥®ËßÜÁÇπÊï∞ÊçÆ
                gazeData.push(gazePoint);
                
                // Ê∑ªÂä†Âà∞ÂêéÂè∞ÁÉ≠ÂäõÂõæ
                let heatPoint = {
                    x: gazePoint.x,
                    y: gazePoint.y,
                    value: Math.min(Math.max(timeDiff / 10, 1), 100)
                };
                heatmapInstance.addData(heatPoint);
                
                gazeCount++;
                totalDuration += timeDiff;
                lastGazePoint = gazePoint;
                
                if (gazeCount % 100 === 0) {
                    debug(`Êï∞ÊçÆÊî∂ÈõÜËøõÂ∫¶: ${gazeCount} Ê≥®ËßÜÁÇπ, ${saccadeCount} ÁúºË∑≥, ${fixationData.length} Ê≥®ËßÜ`);
                }
            }
            
            lastGazeTime = currentTime;
        }

        // WebGazer ÂàùÂßãÂåñ
        async function startEyeTracking() {
            if (!librariesLoaded) {
                alert('Â∫ìÊñá‰ª∂ËøòÊú™Âä†ËΩΩÂÆåÊàêÔºåËØ∑Á≠âÂæÖÂä†ËΩΩÂÆåÊàêÂêéÂÜçËØïÔºÅ');
                return;
            }
            
            initializationAttempts++;
            debug(`ÂºÄÂßãÁ¨¨ ${initializationAttempts} Ê¨°ÂàùÂßãÂåñÂ∞ùËØï`);
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').textContent = 'üîÑ ÂàùÂßãÂåñ‰∏≠...';
            
            updateStatus('ÂàùÂßãÂåñ WebGazer...', 'initializing');
            document.getElementById('systemStatus').textContent = 'ÂàùÂßãÂåñ‰∏≠';

            try {
                await webgazer.setRegression('ridge')
                    .setGazeListener(gazeDataCallback)
                    .saveDataAcrossSessions(true)
                    .begin();
                
                webgazer.showVideoPreview(true)
                        .showPredictionPoints(true)
                        .applyKalmanFilter(true);
                
                debug('WebGazerÂàùÂßãÂåñÂÆåÊàêÔºåËÆæÁΩÆÁîªÂ∏É...');
                
                var canvas = document.getElementById("plotting_canvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                canvas.style.position = 'fixed';
                
                setupCalibrationListeners();
                
                webgazerReady = true;
                isTracking = true;
                
                updateStatus('Á≥ªÁªüÂ∞±Áª™ - ËØ∑ËøõË°åÊ†°ÂáÜ', 'ready');
                document.getElementById('systemStatus').textContent = 'Â∞±Áª™';
                document.getElementById('calibrateBtn').disabled = false;
                document.getElementById('startBtn').textContent = '‚úÖ Â∑≤ÂêØÂä®';
                
                debug('WebGazerÂêØÂä®ÊàêÂäüÔºÅ');
                
                setTimeout(() => {
                    if (PointCalibrate === 0) {
                        let message = 'üéâ Á≥ªÁªüÂ∑≤ÊàêÂäüÂêØÂä®ÔºÅ\n\n';
                        message += 'üìã ‰∏ã‰∏ÄÊ≠•Êìç‰ΩúÔºö\n';
                        message += '1. ÁÇπÂáª"ÊµãËØïFirebaseËøûÊé•"Á°Æ‰øùÊï∞ÊçÆÂèØ‰ª•‰øùÂ≠ò\n';
                        message += '2. ÁÇπÂáª"ÂºÄÂßãÊ†°ÂáÜ"ËøõË°å9ÁÇπÊ†°ÂáÜ\n';
                        message += '3. Ê†°ÂáÜÂÆåÊàêÂêéËá™Âä®ÂºÄÂßãÊï∞ÊçÆÊî∂ÈõÜ\n\n';
                        message += 'üí° ÊèêÁ§∫ÔºöÂè≥‰æßÈù¢Êùø‰ºöÊòæÁ§∫ÂÆûÊó∂Áä∂ÊÄÅ‰ø°ÊÅØ';
                        alert(message);
                    }
                }, 2000);
                
            } catch (error) {
                debug(`WebGazerÂêØÂä®Â§±Ë¥•: ${error.message}`);
                updateStatus('ÂêØÂä®Â§±Ë¥• - ÁÇπÂáªÈáçËØï', 'error');
                document.getElementById('systemStatus').textContent = 'ÂêØÂä®Â§±Ë¥•';
                resetStartButton();
            }
        }
        
        function setupCalibrationListeners() {
            document.querySelectorAll('.Calibration').forEach((i) => {
                i.addEventListener('click', () => {
                    calPointClick(i);
                });
            });
            debug('Ê†°ÂáÜÁÇπÂáªÁõëÂê¨Âô®Â∑≤ËÆæÁΩÆ');
        }
        
        function resetStartButton() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'üîÑ ÈáçËØïÂêØÂä®';
        }

        // ÁªüËÆ°‰ø°ÊÅØÊõ¥Êñ∞
        function updateStats() {
            document.getElementById('totalGazes').textContent = gazeCount;
            document.getElementById('saccadeCount').textContent = saccadeCount;
            
            let elapsedSeconds = (Date.now() - startTime) / 1000;
            document.getElementById('runningTime').textContent = Math.round(elapsedSeconds) + 'Áßí';
        }

        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            debug(`Áä∂ÊÄÅÊõ¥Êñ∞: ${message}`);
        }

        // È°µÈù¢ÂàùÂßãÂåñ
        window.addEventListener('DOMContentLoaded', async function() {
            debug('È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÁ≥ªÁªüÂàùÂßãÂåñ...');
            debug('ÂΩìÂâçÊó∂Èó¥: 2025-08-09 14:07:27 (UTC)');
            debug('ÂΩìÂâçÁî®Êà∑: jingtianwei2002');
            
            try {
                const loaded = await checkLibrariesLoaded();
                if (!loaded) {
                    debug('Â∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåÊó†Ê≥ïÁªßÁª≠ÂàùÂßãÂåñ');
                    return;
                }
                
                debug('Â∫ìÊñá‰ª∂Âä†ËΩΩÊàêÂäüÔºåÂàùÂßãÂåñÂêéÂè∞ÁÉ≠ÂäõÂõæ...');
                
                if (!setupHeatmap()) {
                    updateStatus('ÁÉ≠ÂäõÂõæÂàùÂßãÂåñÂ§±Ë¥•', 'error');
                    return;
                }
                
                updateStatus('ÁÇπÂáªÂêØÂä®ÊåâÈíÆÂºÄÂßã', 'ready');
                debug('Á≥ªÁªüÂáÜÂ§áÂ∞±Áª™ÔºåÁ≠âÂæÖÁî®Êà∑ÂêØÂä®');
                
                document.getElementById('startBtn').disabled = false;
            } catch (error) {
                debug(`ÂàùÂßãÂåñËøáÁ®ãÂá∫Èîô: ${error.message}`);
                updateStatus('ÂàùÂßãÂåñÂ§±Ë¥•', 'error');
            }
        });

        // Ë∞ÉËØïÂíåÂ∑•ÂÖ∑ÂáΩÊï∞
        function debug(message) {
            if (debugMode) {
                console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
                const debugDiv = document.getElementById('debugInfo');
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML = `[${timestamp}] ${message}<br>` + debugDiv.innerHTML;
                
                const lines = debugDiv.innerHTML.split('<br>');
                if (lines.length > 20) {
                    debugDiv.innerHTML = lines.slice(0, 20).join('<br>');
                }
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debugPanel').style.display = debugMode ? 'block' : 'none';
            debug('Ë∞ÉËØïÊ®°ÂºèÂàáÊç¢: ' + (debugMode ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'));
        }

        function updateLoadingProgress(percent) {
            const progressBar = document.getElementById('loadingBar');
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
        }

        function exportData() {
            const stats = {
                sessionId: sessionId,
                exportTime: new Date().toISOString(),
                user: 'jingtianwei2002',
                totalGazePoints: gazeCount,
                totalSaccades: saccadeCount,
                totalFixations: fixationData.length,
                totalSnapshots: snapshotCount,
                averageFixationDuration: calculateAverageFixationDuration(),
                runningTime: Math.round((Date.now() - startTime) / 1000),
                calibrationPoints: PointCalibrate,
                systemReady: webgazerReady,
                firebaseConnected: firebaseConnected,
                accuracyMeasurement: document.getElementById("Accuracy").innerHTML,
                sessionStartTime: sessionStartTime,
                recentGazeData: gazeData,
                recentSaccadeData: saccadeData,
                allFixationData: fixationData
            };
            
            const dataStr = JSON.stringify(stats, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `eye-tracking-export-${sessionId}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            debug(`Êú¨Âú∞Êï∞ÊçÆÂ∑≤ÂØºÂá∫`);
            alert(`üìä Êú¨Âú∞Êï∞ÊçÆÂØºÂá∫ÊàêÂäüÔºÅ\n\nÂåÖÂê´:\n- ${gazeData.length} ‰∏™ÊúÄËøëÊ≥®ËßÜÁÇπ\n- ${saccadeData.length} ‰∏™ÊúÄËøëÁúºË∑≥\n- ${fixationData.length} ‰∏™ÊÄªÊ≥®ËßÜËÆ∞ÂΩï\n- ${snapshotCount} ‰∏™‰∫ëÁ´ØÂø´ÁÖßËÆ∞ÂΩï`);
        }

        function stopTracking() {
            isTracking = false;
            webgazerReady = false;
            isStoring = false;
            
            stopAutoSave();
            
            try {
                if (typeof webgazer !== 'undefined' && webgazer.isReady && webgazer.isReady()) {
                    webgazer.end();
                    debug('WebGazerÂ∑≤ÂÅúÊ≠¢');
                }
            } catch (error) {
                debug(`ÂÅúÊ≠¢WebGazerÊó∂Âá∫Èîô: ${error.message}`);
            }
            
            updateStatus('Êï∞ÊçÆÊî∂ÈõÜÂ∑≤ÂÅúÊ≠¢', 'error');
            document.getElementById('systemStatus').textContent = 'Â∑≤ÂÅúÊ≠¢';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'üöÄ ÂêØÂä®ÁúºÂä®ËøΩË∏™';
            document.getElementById('calibrateBtn').disabled = true;
            
            ClearCalibration();
            ClearCanvas();
            
            debug('ÁúºÂä®ËøΩË∏™Â∑≤ÂÅúÊ≠¢');
        }

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜËµÑÊ∫ê
        window.onbeforeunload = function() {
            stopAutoSave();
            if (typeof webgazer !== 'undefined') {
                webgazer.end();
                debug('È°µÈù¢Âç∏ËΩΩÔºåWebGazerËµÑÊ∫êÂ∑≤Ê∏ÖÁêÜ');
            }
        }

        setInterval(updateStats, 1000);

        // ÈîôËØØÂ§ÑÁêÜ
        window.addEventListener('error', function(event) {
            debug(`ÂÖ®Â±ÄÈîôËØØ: ${event.error?.message || event.message}`);
            console.error('È°µÈù¢ÈîôËØØ:', event);
        });

        window.addEventListener('unhandledrejection', function(event) {
            debug(`Êú™Â§ÑÁêÜÁöÑPromiseÊãíÁªù: ${event.reason}`);
            console.error('PromiseÈîôËØØ:', event.reason);
        });
    </script>
</body>
</html>
